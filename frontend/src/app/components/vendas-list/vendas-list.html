<div class="vendas-page">
  <section *ngIf="error" class="state-card error-message">
    <i class="fas fa-exclamation-triangle"></i>
    {{ error }}
  </section>

  <section class="results-card" *ngIf="!error">
    <div class="results-header">
      <div class="header-actions">
        <button
          *ngIf="canCreateVenda()"
          class="btn btn-novo"
          (click)="openNewVendaModal()"
          [attr.disabled]="loading ? 'disabled' : null">
          <i class="fas fa-plus"></i>
          Nova Venda
        </button>
        <button
          *ngIf="canEditVenda()"
          class="btn btn-editar"
          (click)="editSelectedVenda()"
          title="Editar venda selecionada">
          <i class="fas fa-pen"></i>
          Editar
        </button>
        <button
          *ngIf="canLancarBaixa()"
          class="btn btn-baixa"
          (click)="lancarBaixaSelecionada()"
          title="Lançar baixa para venda selecionada">
          <i class="fas fa-dollar-sign"></i>
          Baixa
        </button>
        <button
          *ngIf="canAuditVenda()"
          class="btn btn-auditoria"
          (click)="abrirAuditoriaVendaSelecionada()"
          title="Ver histórico da venda selecionada">
          <i class="fas fa-history"></i>
          Auditoria
        </button>
        <button
          *ngIf="canDeleteVenda()"
          class="btn btn-excluir"
          (click)="openBulkDeleteModal()"
          title="Excluir vendas selecionadas">
          <i class="fas fa-trash"></i>
          Excluir
        </button>
        <button
          *ngIf="canReadVenda()"
          class="btn btn-imprimir"
          (click)="imprimirFechamentoAtual()"
          [attr.disabled]="selectedVendas.size === 0 || loading ? 'disabled' : null"
          title="Imprimir vendas selecionadas">
          <i class="fas fa-print"></i>
          Imprimir
        </button>
        <button
          *ngIf="canReadVenda()"
          class="btn btn-exportar"
          (click)="exportarSelecionadasParaExcel()"
          [attr.disabled]="selectedVendas.size === 0 || loading ? 'disabled' : null"
          title="Exportar vendas selecionadas para Excel">
          <i class="fas fa-file-excel"></i>
          Exportar
        </button>
      </div>
    </div>
    <div class="inline-loading" *ngIf="loading">
      <div class="spinner"></div>
      <span>Atualizando lista de vendas...</span>
    </div>
    <div class="filters-inline">
      <div
        class="filters-panel-top"
        role="button"
        tabindex="0"
        (click)="onContainerClick($event)"
        (keydown)="onFiltersToggleKey($event)">
        <div class="filters-controls">
          <button
            type="button"
            class="filters-toggle btn btn-toggle-filtros"
            (click)="toggleFiltersVisibility(); $event.stopPropagation()"
            (mousedown)="$event.stopPropagation()">
            <span>{{ filtersPanelOpen ? 'Fechar filtros' : 'Abrir filtros' }}</span>
            <span class="filters-count" *ngIf="appliedFilters.length">
              {{ appliedFilters.length }}
            </span>
            <i
              class="fas"
              [class.fa-chevron-up]="filtersPanelOpen"
              [class.fa-chevron-down]="!filtersPanelOpen"></i>
          </button>
          <!-- Área de filtros aplicados melhorada -->
          <div
            class="applied-filters-container"
            *ngIf="appliedFilters.length">
            
            <!-- Contador de resultados -->
            <div class="results-count" *ngIf="totalItems !== undefined" (click)="$event.stopPropagation()">
              <i class="fas fa-filter"></i>
              <span>{{ totalItems }} resultado(s)</span>
            </div>
            
            <!-- Container com scroll horizontal -->
            <div class="applied-filters-wrapper">
              <div class="applied-filters-list">
                <!-- Filtros de texto -->
                <ng-container *ngFor="let filter of appliedFilters">
                  <span 
                    class="filter-chip" 
                    [class.filter-chip-multiple]="isMultipleFilter(filter.key)"
                    [title]="filter.value">
                    <i class="fas" [ngClass]="getFilterIcon(filter.key)"></i>
                    <strong>{{ filter.label }}:</strong> 
                    <span class="filter-value">{{ formatFilterValue(filter) }}</span>
                    <button
                      class="chip-remove"
                      type="button"
                      (click)="clearAppliedFilter(filter.key); $event.stopPropagation()"
                      aria-label="Remover filtro {{ filter.label }}">
                      <i class="fas fa-times"></i>
                    </button>
                  </span>
                </ng-container>
              </div>
            </div>
            
            <!-- Botão limpar todos -->
            <button
              class="btn-clear-all"
              type="button"
              (click)="clearFilters(); $event.stopPropagation()"
              title="Limpar todos os filtros">
              <i class="fas fa-eraser"></i>
              Limpar todos
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="table-wrapper">
      <table class="vendas-table">
        <thead>
          <tr>
            <th class="checkbox-column">
              <input
                type="checkbox"
                [checked]="isAllSelected()"
                [indeterminate]="isIndeterminate()"
                (change)="toggleSelectAll()"
                title="Marcar/Desmarcar todas as vendas">
            </th>
            <th
              class="sortable"
              (click)="onSort('protocolo')"
              [class.sorted]="sortField === 'protocolo'"
              [attr.aria-sort]="sortField === 'protocolo' ? sortDirection : 'none'">
              Protocolo
              <i class="fas sort-icon" *ngIf="sortField === 'protocolo'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('dataVenda')"
              [class.sorted]="sortField === 'dataVenda'"
              [attr.aria-sort]="sortField === 'dataVenda' ? sortDirection : 'none'">
              D. Venda
              <i class="fas sort-icon" *ngIf="sortField === 'dataVenda'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('dataEnvio')"
              [class.sorted]="sortField === 'dataEnvio'"
              [attr.aria-sort]="sortField === 'dataEnvio' ? sortDirection : 'none'">
              D. Envio
              <i class="fas sort-icon" *ngIf="sortField === 'dataEnvio'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('cliente')"
              [class.sorted]="sortField === 'cliente'"
              [attr.aria-sort]="sortField === 'cliente' ? sortDirection : 'none'">
              Cliente
              <i class="fas sort-icon" *ngIf="sortField === 'cliente'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('origem')"
              [class.sorted]="sortField === 'origem'"
              [attr.aria-sort]="sortField === 'origem' ? sortDirection : 'none'">
              Comprado em
              <i class="fas sort-icon" *ngIf="sortField === 'origem'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('vendedor')"
              [class.sorted]="sortField === 'vendedor'"
              [attr.aria-sort]="sortField === 'vendedor' ? sortDirection : 'none'">
              Vendedor
              <i class="fas sort-icon" *ngIf="sortField === 'vendedor'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('prescritor')"
              [class.sorted]="sortField === 'prescritor'"
              [attr.aria-sort]="sortField === 'prescritor' ? sortDirection : 'none'">
              Prescritor
              <i class="fas sort-icon" *ngIf="sortField === 'prescritor'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('ativo')"
              [class.sorted]="sortField === 'ativo'"
              [attr.aria-sort]="sortField === 'ativo' ? sortDirection : 'none'">
              Ativo
              <i class="fas sort-icon" *ngIf="sortField === 'ativo'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              *ngIf="canViewValorCompra()"
              class="sortable"
              (click)="onSort('valorCompra')"
              [class.sorted]="sortField === 'valorCompra'"
              [attr.aria-sort]="sortField === 'valorCompra' ? sortDirection : 'none'">
              V. Compras
              <i class="fas sort-icon" *ngIf="sortField === 'valorCompra'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('valorCliente')"
              [class.sorted]="sortField === 'valorCliente'"
              [attr.aria-sort]="sortField === 'valorCliente' ? sortDirection : 'none'">
              V. Cliente
              <i class="fas sort-icon" *ngIf="sortField === 'valorCliente'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('valorPago')"
              [class.sorted]="sortField === 'valorPago'"
              [attr.aria-sort]="sortField === 'valorPago' ? sortDirection : 'none'">
              V. Pago
              <i class="fas sort-icon" *ngIf="sortField === 'valorPago'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('status')"
              [class.sorted]="sortField === 'status'"
              [attr.aria-sort]="sortField === 'status' ? sortDirection : 'none'">
              Status
              <i class="fas sort-icon" *ngIf="sortField === 'status'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('observacao')"
              [class.sorted]="sortField === 'observacao'"
              [attr.aria-sort]="sortField === 'observacao' ? sortDirection : 'none'">
              Observação
              <i class="fas sort-icon" *ngIf="sortField === 'observacao'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let venda of items"
            (click)="onRowClick($event, venda.id)"
            (contextmenu)="onRowContextMenu($event, venda)"
            [class.row-selected]="isVendaSelected(venda.id)">
            <td class="checkbox-column">
              <input
                type="checkbox"
                [checked]="isVendaSelected(venda.id)"
                (click)="$event.stopPropagation()"
                (change)="toggleSelectVenda(venda.id)"
                title="Selecionar venda">
            </td>
            <td>{{ venda.protocolo }}</td>
            <td>{{ formatDate(venda.dataVenda) }}</td>
            <td>{{ venda.dataEnvio ? formatDate(venda.dataEnvio) : '-' }}</td>
            <td>{{ getClienteNome(venda) }}</td>
            <td>{{ getOrigemLabel(venda.origem) }}</td>
            <td>{{ getVendedorNome(venda) }}</td>
            <td>{{ getPrescritorNome(venda) || '-' }}</td>
            <td>{{ venda.ativo || '-' }}</td>
            <td *ngIf="canViewValorCompra()">{{ formatCurrency(venda.valorCompra || 0) }}</td>
            <td>{{ formatCurrency(venda.valorCliente) }}</td>
            <td>{{ formatCurrency(getValorBaixadoForVenda(venda.id)) }}</td>
            <td>
              <span class="status-badge {{ getStatusClass(venda.status) }}">
                {{ getStatusLabel(venda.status) }}
              </span>
            </td>
            <td class="observacao-cell">{{ venda.observacao || '-' }}</td>
          </tr>
          <tr *ngIf="items.length === 0 && !loading" class="no-data">
            <td [attr.colspan]="canViewValorCompra() ? 14 : 13" class="text-center">
              <i class="fas fa-inbox"></i>
              Nenhuma venda encontrada
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination" *ngIf="totalPages > 1">
      <button
        class="btn btn-sm btn-cancelar"
        (click)="onPageChange(currentPage - 1)"
        [attr.disabled]="(currentPage === 1 || loading) ? 'disabled' : null">
        <i class="fas fa-chevron-left"></i> Anterior
      </button>

      <span class="page-info">
        Página {{ currentPage }} de {{ totalPages }} ({{ totalItems }} registros)
      </span>

      <button
        class="btn btn-sm btn-cancelar"
        (click)="onPageChange(currentPage + 1)"
        [attr.disabled]="(currentPage === totalPages || loading) ? 'disabled' : null">
        Próximo <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </section>
</div>

<div
  class="context-menu-overlay"
  *ngIf="contextMenuVisible"
  (click)="closeContextMenu()"
  (contextmenu)="closeContextMenu()">
</div>
<div
  class="context-menu"
  *ngIf="contextMenuVisible"
  [ngStyle]="{ top: contextMenuPosition.y + 'px', left: contextMenuPosition.x + 'px' }"
  (click)="$event.stopPropagation()">
  <button type="button" (click)="onContextEdit()" [disabled]="!canEditVenda()">
    <i class="fas fa-pen"></i> Editar
  </button>
  <button type="button" (click)="onContextBaixa()" [disabled]="!canLancarBaixa()">
    <i class="fas fa-dollar-sign"></i> Baixa
  </button>
  <button type="button" (click)="onContextAuditoria()" [disabled]="!canAuditVenda()">
    <i class="fas fa-history"></i> Auditoria
  </button>
  <button type="button" class="danger" (click)="onContextExcluir()" [disabled]="!canDeleteVenda()">
    <i class="fas fa-trash"></i> Excluir
  </button>
</div>

<app-venda-modal
  [showModal]="showVendaModal"
  [venda]="selectedVenda"
  (close)="onVendaModalClose()"
  (saved)="onVendaSaved($event)">
</app-venda-modal>

<app-historico-auditoria
  *ngIf="selectedVendaForAudit"
  [entidade]="'vendas'"
  [entidadeId]="selectedVendaForAudit.id"
  [fieldLabels]="getAuditFieldLabels()"
  [showModal]="showAuditModal"
  (modalClosed)="closeAuditModal()">
</app-historico-auditoria>

<app-lancar-baixa-modal
  [showModal]="showBaixaModal"
  [venda]="selectedVendaForBaixa"
  (close)="closeBaixaModal()"
  (modalClosed)="onBaixaModalClosed()">
</app-lancar-baixa-modal>

<div
  class="confirmation-modal-overlay"
  *ngIf="showMassBaixaModal"
  (click)="massBaixaLoading ? null : closeMassBaixaModal()">
  <div class="confirmation-modal mass-baixa-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Processar baixas em massa</h3>
      <button
        type="button"
        class="close-btn"
        (click)="closeMassBaixaModal()"
        [attr.disabled]="massBaixaLoading ? 'disabled' : null">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>
        Serão processadas {{ selectedVendas.size }} venda(s).
        Apenas vendas com status
        <strong *ngFor="let status of massBaixaAllowedStatuses; let last = last">
          {{ getStatusLabel(status) }}<ng-container *ngIf="!last">, </ng-container>
        </strong>
        serão atualizadas automaticamente.
      </p>
      <div class="mass-baixa-form">
        <div class="form-field">
          <label for="massTipoBaixa">Tipo da baixa</label>
          <select
            id="massTipoBaixa"
            class="campo"
            [(ngModel)]="massBaixaForm.tipoDaBaixa"
            [ngModelOptions]="{ standalone: true }"
            [attr.disabled]="massBaixaLoading ? 'disabled' : null">
            <option *ngFor="let tipo of tiposBaixa" [value]="tipo">
              {{ tipo }}
            </option>
          </select>
        </div>
        <div class="form-field">
          <label for="massDataBaixa">Data da baixa</label>
          <input
            id="massDataBaixa"
            type="date"
            class="campo"
            [(ngModel)]="massBaixaForm.dataBaixa"
            [ngModelOptions]="{ standalone: true }"
            [attr.disabled]="massBaixaLoading ? 'disabled' : null">
        </div>
        <div class="form-field">
          <label for="massObservacao">Observação</label>
          <textarea
            id="massObservacao"
            class="campo"
            rows="3"
            placeholder="Opcional"
            [(ngModel)]="massBaixaForm.observacao"
            [ngModelOptions]="{ standalone: true }"
            [attr.disabled]="massBaixaLoading ? 'disabled' : null"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button
        class="btn btn-cancelar"
        type="button"
        (click)="closeMassBaixaModal()"
        [attr.disabled]="massBaixaLoading ? 'disabled' : null">
        Cancelar
      </button>
      <button
        class="btn btn-baixa"
        type="button"
        (click)="processarBaixasEmMassa()"
        [attr.disabled]="massBaixaLoading ? 'disabled' : null">
        <i class="fas" [ngClass]="massBaixaLoading ? 'fa-spinner fa-spin' : 'fa-check'"></i>
        {{ massBaixaLoading ? 'Processando...' : 'Processar baixas' }}
      </button>
    </div>
  </div>
</div>

<div class="confirmation-modal-overlay" *ngIf="showDeleteModal || showBulkDeleteModal" (click)="showBulkDeleteModal ? closeBulkDeleteModal() : onDeleteCancelled()">
  <div class="confirmation-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ showBulkDeleteModal ? 'Excluir vendas selecionadas' : 'Confirmação de Exclusão' }}</h3>
      <button type="button" class="close-btn" (click)="showBulkDeleteModal ? closeBulkDeleteModal() : onDeleteCancelled()" [attr.disabled]="bulkDeleteLoading ? 'disabled' : null">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p *ngIf="!showBulkDeleteModal">{{ deleteModalMessage }}</p>
      <p *ngIf="showBulkDeleteModal">Tem certeza que deseja excluir {{ selectedVendas.size }} venda(s) selecionadas?</p>
      <p class="warning-text">
        <i class="fas fa-exclamation-circle"></i>
        Esta ação não pode ser desfeita.
      </p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-cancelar" type="button" (click)="showBulkDeleteModal ? closeBulkDeleteModal() : onDeleteCancelled()" [attr.disabled]="showBulkDeleteModal && bulkDeleteLoading ? 'disabled' : null">
        Cancelar
      </button>
      <button
        class="btn btn-excluir"
        type="button"
        (click)="showBulkDeleteModal ? confirmBulkDelete() : onDeleteConfirmed()"
        [attr.disabled]="showBulkDeleteModal && bulkDeleteLoading ? 'disabled' : null">
        <i class="fas fa-trash"></i>
        {{ showBulkDeleteModal ? (bulkDeleteLoading ? 'Excluindo...' : 'Excluir') : 'Excluir' }}
      </button>
    </div>
  </div>
</div>

<!-- Modal de Filtros -->
<div class="modal-overlay" *ngIf="filtersPanelOpen" (click)="toggleFiltersVisibility()">
  <div class="modal-conteudo modal-filtros" (click)="$event.stopPropagation()">
    <div class="modal-cabecalho">
      <h3 class="modal-titulo">Filtros de Vendas</h3>
      <button type="button" class="modal-fechar" (click)="toggleFiltersVisibility()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-corpo">
      <div class="filters-grid">
        <!-- Primeira linha: Datas -->
        <div class="filter-group date-range-field">
          <app-date-range-filter
            label="Data da Venda"
            startLabel="Início"
            endLabel="Fim"
            [start]="dataInicialFilter"
            [end]="dataFinalFilter"
            (rangeChange)="onVendaRangeChangeModal($event)">
          </app-date-range-filter>
        </div>

        <div class="filter-group date-range-field">
          <app-date-range-filter
            label="Data de Fechamento"
            startLabel="Início"
            endLabel="Fim"
            [start]="dataInicialFechamentoFilter"
            [end]="dataFinalFechamentoFilter"
            (rangeChange)="onFechamentoRangeChangeModal($event)">
          </app-date-range-filter>
        </div>

        <!-- Segunda linha: Protocolo, Cliente, Vendedor, Prescritor -->
        <div class="filter-group">
          <label for="protocoloFilterModal" class="label-campo">Protocolo</label>
          <input
            id="protocoloFilterModal"
            type="text"
            [(ngModel)]="protocoloFilter"
            placeholder="Buscar por protocolo..."
            class="campo"
            (keyup.enter)="applyFilters()">
        </div>

        <div class="filter-group">
          <label for="clienteFilterModal" class="label-campo">Cliente</label>
          <input
            id="clienteFilterModal"
            type="text"
            [(ngModel)]="clienteFilter"
            placeholder="Buscar por cliente..."
            class="campo"
            (keyup.enter)="applyFilters()">
        </div>

        <div class="filter-group">
          <label for="vendedorFilterModal" class="label-campo">Vendedor</label>
          <input
            id="vendedorFilterModal"
            type="text"
            [(ngModel)]="vendedorFilter"
            placeholder="Buscar por vendedor..."
            class="campo"
            (keyup.enter)="applyFilters()">
        </div>

        <div class="filter-group">
          <label for="prescritorFilterModal" class="label-campo">Prescritor</label>
          <input
            id="prescritorFilterModal"
            type="text"
            [(ngModel)]="prescritorFilter"
            placeholder="Buscar por prescritor..."
            class="campo"
            (keyup.enter)="applyFilters()">
        </div>

        <!-- Terceira linha: Ativo, Comprado em, Status, Unidade -->
        <div class="filter-group">
          <label for="ativoFilterModal" class="label-campo">Ativo</label>
          <input
            id="ativoFilterModal"
            type="text"
            [(ngModel)]="ativoFilter"
            placeholder="Buscar por ativo..."
            class="campo"
            (keyup.enter)="applyFilters()">
        </div>

        <div class="filter-group">
          <label class="label-campo">Comprado em</label>
          <app-multi-select-dropdown
            [(ngModel)]="origemFilter"
            [options]="getOrigemOptions()"
            placeholder="Selecione as origens..."
            selectAllLabel="Marcar todas"
            deselectAllLabel="Desmarcar todas">
          </app-multi-select-dropdown>
        </div>

        <div class="filter-group">
          <label class="label-campo">Status</label>
          <app-multi-select-dropdown
            [(ngModel)]="statusFilter"
            [options]="getStatusOptions()"
            placeholder="Selecione os status..."
            selectAllLabel="Marcar todos"
            deselectAllLabel="Desmarcar todos">
          </app-multi-select-dropdown>
        </div>

        <div class="filter-group">
          <label class="label-campo">Unidade</label>
          <app-multi-select-dropdown
            [(ngModel)]="unidadeFilter"
            [options]="getUnidadeOptions()"
            [disabled]="unidadeDisabled"
            placeholder="Selecione as unidades..."
            selectAllLabel="Marcar todas"
            deselectAllLabel="Desmarcar todas">
          </app-multi-select-dropdown>
        </div>
      </div>
    </div>

    <div class="modal-rodape">
      <button
        type="button"
        class="botao botao-fantasma"
        (click)="clearFilters()">
        <i class="fas fa-eraser"></i>
        Limpar Filtros
      </button>
      <button
        type="button"
        class="botao botao-primario"
        (click)="applyFilters()">
        <i class="fas fa-filter"></i>
        Aplicar Filtros
      </button>
    </div>
  </div>
</div>
