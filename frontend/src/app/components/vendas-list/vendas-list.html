<div class="vendas-page">
  <section *ngIf="error" class="state-card error-message">
    <i class="fas fa-exclamation-triangle"></i>
    {{ error }}
  </section>

  <section class="results-card" *ngIf="!error">
    <div class="results-header">
      <div class="header-actions">
        <button
          *ngIf="canCreateVenda()"
          class="btn btn-novo"
          (click)="openNewVendaModal()"
          [attr.disabled]="loading ? 'disabled' : null">
          <i class="fas fa-plus"></i>
          Nova Venda
        </button>
        <button
          *ngIf="canEditVenda()"
          class="btn btn-editar"
          (click)="editSelectedVenda()"
          title="Editar venda selecionada">
          <i class="fas fa-pen"></i>
          Editar
        </button>
        <button
          *ngIf="canLancarBaixa()"
          class="btn btn-baixa"
          (click)="lancarBaixaSelecionada()"
          title="Lançar baixa para venda selecionada">
          <i class="fas fa-dollar-sign"></i>
          Baixa
        </button>
        <button
          *ngIf="canAuditVenda()"
          class="btn btn-auditoria"
          (click)="abrirAuditoriaVendaSelecionada()"
          title="Ver histórico da venda selecionada">
          <i class="fas fa-history"></i>
          Auditoria
        </button>
        <button
          *ngIf="canFecharVendas()"
          class="btn btn-fechar"
          (click)="fecharVendasSelecionadas()"
          title="Fechar vendas selecionadas">
          <i class="fas fa-lock"></i>
          Fechar Vendas
        </button>
        <button
          *ngIf="canCancelarFechamento()"
          class="btn btn-cancelar-fechamento"
          (click)="cancelarFechamentosSelecionados()"
          title="Cancelar fechamento das vendas selecionadas">
          <i class="fas fa-unlock"></i>
          Cancelar Fechamento
        </button>
        <button
          *ngIf="canDeleteVenda()"
          class="btn btn-excluir"
          (click)="openBulkDeleteModal()"
          title="Excluir vendas selecionadas">
          <i class="fas fa-trash"></i>
          Excluir
        </button>
        <button
          *ngIf="canReadVenda()"
          class="btn btn-imprimir"
          (click)="imprimirFechamentoAtual()"
          [attr.disabled]="selectedVendas.size === 0 || loading ? 'disabled' : null"
          title="Imprimir vendas selecionadas">
          <i class="fas fa-print"></i>
          Imprimir
        </button>
        <button
          *ngIf="canReadVenda()"
          class="btn btn-exportar"
          (click)="exportarSelecionadasParaExcel()"
          [attr.disabled]="selectedVendas.size === 0 || loading ? 'disabled' : null"
          title="Exportar vendas selecionadas para Excel">
          <i class="fas fa-file-excel"></i>
          Exportar
        </button>
      </div>
    </div>
    <div class="inline-loading" *ngIf="loading">
      <div class="spinner"></div>
      <span>Atualizando lista de vendas...</span>
    </div>
    <div class="filters-inline">
      <div
        class="filters-panel-top"
        role="button"
        tabindex="0"
        (click)="toggleFiltersVisibility()"
        (keydown)="onFiltersToggleKey($event)">
        <div class="filters-controls">
          <div class="filters-toggle btn btn-toggle-filtros">
            <span>{{ filtersPanelOpen ? 'Ocultar filtros' : 'Mostrar filtros' }}</span>
            <span class="filters-count" *ngIf="appliedFilters.length">
              {{ appliedFilters.length }}
            </span>
            <i
              class="fas"
              [class.fa-chevron-up]="filtersPanelOpen"
              [class.fa-chevron-down]="!filtersPanelOpen"></i>
          </div>
          <div
            class="applied-filters-inline"
            *ngIf="appliedFilters.length"
            (click)="$event.stopPropagation()"
            (keydown)="$event.stopPropagation()">
            <div class="applied-filters-list">
              <span class="filter-chip" *ngFor="let filter of appliedFilters">
                <strong>{{ filter.label }}:</strong> {{ filter.value }}
                <button
                  class="chip-remove"
                  type="button"
                  (click)="clearAppliedFilter(filter.key); $event.stopPropagation()"
                  aria-label="Remover filtro {{ filter.label }}">
                  ×
                </button>
              </span>
            </div>
          </div>
        </div>
      </div>
      <div class="filters" *ngIf="filtersPanelOpen">
        <div class="filter-group">
          <label for="protocoloFilter">Protocolo</label>
          <input
            id="protocoloFilter"
            type="text"
            [(ngModel)]="protocoloFilter"
            placeholder="Buscar por protocolo..."
            class="form-control"
            (keyup.enter)="onFilterChange()">
        </div>

        <div class="filter-group">
          <label for="clienteFilter">Cliente</label>
          <input
            id="clienteFilter"
            type="text"
            [(ngModel)]="clienteFilter"
            placeholder="Buscar por cliente..."
            class="form-control"
            (keyup.enter)="onFilterChange()">
        </div>

        <div class="filter-group">
          <label for="vendedorFilter">Vendedor</label>
          <input
            id="vendedorFilter"
            type="text"
            [(ngModel)]="vendedorFilter"
            placeholder="Buscar por vendedor..."
            class="form-control"
            (keyup.enter)="onFilterChange()">
        </div>

        <div class="filter-group">
          <label for="prescritorFilter">Prescritor</label>
          <input
            id="prescritorFilter"
            type="text"
            [(ngModel)]="prescritorFilter"
            placeholder="Buscar por prescritor..."
            class="form-control"
            (keyup.enter)="onFilterChange()">
        </div>

        <div class="filter-group">
          <label for="ativoFilter">Ativo</label>
          <input
            id="ativoFilter"
            type="text"
            [(ngModel)]="ativoFilter"
            placeholder="Buscar por ativo..."
            class="form-control"
            (keyup.enter)="onFilterChange()">
        </div>

        <div class="filter-group">
          <label for="origemFilter">Comprado em</label>
          <select
            id="origemFilter"
            [(ngModel)]="origemFilter"
            class="form-control"
            (change)="onFilterChange()">
            <option value="">Todas</option>
            <option *ngFor="let origem of [VendaOrigem.GOIANIA, VendaOrigem.INHUMAS, VendaOrigem.UBERABA, VendaOrigem.NEROPOLIS, VendaOrigem.OUTRO]" [value]="origem">
              {{ getOrigemLabel(origem) }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label for="statusFilter">Status</label>
          <select
            id="statusFilter"
            [(ngModel)]="statusFilter"
            class="form-control"
            (change)="onFilterChange()">
            <option value="">Todos</option>
            <option *ngFor="let status of [VendaStatus.REGISTRADO, VendaStatus.CANCELADO, VendaStatus.PAGO, VendaStatus.PAGO_PARCIAL, VendaStatus.FECHADO]" [value]="status">
              {{ getStatusLabel(status) }}
            </option>
          </select>
        </div>

        <div class="filter-group date-field date-range-field">
          <app-date-range-filter
            label="Data da Venda"
            startLabel="Início"
            endLabel="Fim"
            [start]="dataInicialFilter"
            [end]="dataFinalFilter"
            (rangeChange)="onVendaRangeChange($event)">
          </app-date-range-filter>
        </div>

        <div class="filter-group date-field date-range-field">
          <app-date-range-filter
            label="Data de Fechamento"
            startLabel="Início"
            endLabel="Fim"
            [start]="dataInicialFechamentoFilter"
            [end]="dataFinalFechamentoFilter"
            (rangeChange)="onFechamentoRangeChange($event)">
          </app-date-range-filter>
        </div>

        <div class="filter-group">
          <label for="unidadeFilter">Unidade</label>
          <select
            id="unidadeFilter"
            [(ngModel)]="unidadeFilter"
            [disabled]="unidadeDisabled"
            class="form-control"
            (change)="onFilterChange()">
            <option value="">Todas</option>
            <option *ngFor="let unidade of unidades" [value]="unidade">
              {{ unidade }}
            </option>
          </select>
        </div>

        <div class="filter-group filter-actions">
          <label>&nbsp;</label>
          <div class="filter-action-buttons">
            <button class="btn btn-limpar" type="button" (click)="clearFilters()">
              <i class="fas fa-eraser"></i>
              Limpar Filtro
            </button>
            <button class="btn btn-filtrar" type="button" (click)="applyFilters()">
              <i class="fas fa-filter"></i>
              Aplicar Filtros
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="table-wrapper">
      <table class="vendas-table">
        <thead>
          <tr>
            <th class="checkbox-column">
              <input
                type="checkbox"
                [checked]="isAllSelected()"
                [indeterminate]="isIndeterminate()"
                (change)="toggleSelectAll()"
                title="Marcar/Desmarcar todas as vendas">
            </th>
            <th
              class="sortable"
              (click)="onSort('protocolo')"
              [class.sorted]="sortField === 'protocolo'"
              [attr.aria-sort]="sortField === 'protocolo' ? sortDirection : 'none'">
              Protocolo
              <i class="fas sort-icon" *ngIf="sortField === 'protocolo'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('dataVenda')"
              [class.sorted]="sortField === 'dataVenda'"
              [attr.aria-sort]="sortField === 'dataVenda' ? sortDirection : 'none'">
              D. Venda
              <i class="fas sort-icon" *ngIf="sortField === 'dataVenda'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('dataFechamento')"
              [class.sorted]="sortField === 'dataFechamento'"
              [attr.aria-sort]="sortField === 'dataFechamento' ? sortDirection : 'none'">
              D. Fechamento
              <i class="fas sort-icon" *ngIf="sortField === 'dataFechamento'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('cliente')"
              [class.sorted]="sortField === 'cliente'"
              [attr.aria-sort]="sortField === 'cliente' ? sortDirection : 'none'">
              Cliente
              <i class="fas sort-icon" *ngIf="sortField === 'cliente'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('origem')"
              [class.sorted]="sortField === 'origem'"
              [attr.aria-sort]="sortField === 'origem' ? sortDirection : 'none'">
              Comprado em
              <i class="fas sort-icon" *ngIf="sortField === 'origem'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('vendedor')"
              [class.sorted]="sortField === 'vendedor'"
              [attr.aria-sort]="sortField === 'vendedor' ? sortDirection : 'none'">
              Vendedor
              <i class="fas sort-icon" *ngIf="sortField === 'vendedor'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('prescritor')"
              [class.sorted]="sortField === 'prescritor'"
              [attr.aria-sort]="sortField === 'prescritor' ? sortDirection : 'none'">
              Prescritor
              <i class="fas sort-icon" *ngIf="sortField === 'prescritor'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('ativo')"
              [class.sorted]="sortField === 'ativo'"
              [attr.aria-sort]="sortField === 'ativo' ? sortDirection : 'none'">
              Ativo
              <i class="fas sort-icon" *ngIf="sortField === 'ativo'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              *ngIf="canViewValorCompra()"
              class="sortable"
              (click)="onSort('valorCompra')"
              [class.sorted]="sortField === 'valorCompra'"
              [attr.aria-sort]="sortField === 'valorCompra' ? sortDirection : 'none'">
              V. Compras
              <i class="fas sort-icon" *ngIf="sortField === 'valorCompra'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('valorCliente')"
              [class.sorted]="sortField === 'valorCliente'"
              [attr.aria-sort]="sortField === 'valorCliente' ? sortDirection : 'none'">
              V. Cliente
              <i class="fas sort-icon" *ngIf="sortField === 'valorCliente'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('valorPago')"
              [class.sorted]="sortField === 'valorPago'"
              [attr.aria-sort]="sortField === 'valorPago' ? sortDirection : 'none'">
              V. Pago
              <i class="fas sort-icon" *ngIf="sortField === 'valorPago'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('status')"
              [class.sorted]="sortField === 'status'"
              [attr.aria-sort]="sortField === 'status' ? sortDirection : 'none'">
              Status
              <i class="fas sort-icon" *ngIf="sortField === 'status'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
            <th
              class="sortable"
              (click)="onSort('observacao')"
              [class.sorted]="sortField === 'observacao'"
              [attr.aria-sort]="sortField === 'observacao' ? sortDirection : 'none'">
              Observação
              <i class="fas sort-icon" *ngIf="sortField === 'observacao'" [ngClass]="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let venda of items"
            (click)="onRowClick($event, venda.id)"
            (contextmenu)="onRowContextMenu($event, venda)"
            [class.row-selected]="isVendaSelected(venda.id)">
            <td class="checkbox-column">
              <input
                type="checkbox"
                [checked]="isVendaSelected(venda.id)"
                (click)="$event.stopPropagation()"
                (change)="toggleSelectVenda(venda.id)"
                title="Selecionar venda">
            </td>
            <td>{{ venda.protocolo }}</td>
            <td>{{ formatDate(venda.dataVenda) }}</td>
            <td>{{ venda.dataFechamento ? formatDate(venda.dataFechamento) : '-' }}</td>
            <td>{{ venda.cliente }}</td>
            <td>{{ getOrigemLabel(venda.origem) }}</td>
            <td>{{ venda.vendedor }}</td>
            <td>{{ venda.prescritor || '-' }}</td>
            <td>{{ venda.ativo || '-' }}</td>
            <td *ngIf="canViewValorCompra()">{{ formatCurrency(venda.valorCompra) }}</td>
            <td>{{ formatCurrency(venda.valorCliente) }}</td>
            <td>{{ formatCurrency(getValorBaixadoForVenda(venda.id)) }}</td>
            <td>
              <span class="status-badge {{ getStatusClass(venda.status) }}">
                {{ getStatusLabel(venda.status) }}
              </span>
            </td>
            <td class="observacao-cell">{{ venda.observacao || '-' }}</td>
          </tr>
          <tr *ngIf="items.length === 0 && !loading" class="no-data">
            <td [attr.colspan]="canViewValorCompra() ? 14 : 13" class="text-center">
              <i class="fas fa-inbox"></i>
              Nenhuma venda encontrada
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination" *ngIf="totalPages > 1">
      <button
        class="btn btn-sm btn-cancelar"
        (click)="onPageChange(currentPage - 1)"
        [attr.disabled]="(currentPage === 1 || loading) ? 'disabled' : null">
        <i class="fas fa-chevron-left"></i> Anterior
      </button>

      <span class="page-info">
        Página {{ currentPage }} de {{ totalPages }} ({{ totalItems }} registros)
      </span>

      <button
        class="btn btn-sm btn-cancelar"
        (click)="onPageChange(currentPage + 1)"
        [attr.disabled]="(currentPage === totalPages || loading) ? 'disabled' : null">
        Próximo <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </section>
</div>

<div
  class="context-menu-overlay"
  *ngIf="contextMenuVisible"
  (click)="closeContextMenu()"
  (contextmenu)="closeContextMenu()">
</div>
<div
  class="context-menu"
  *ngIf="contextMenuVisible"
  [ngStyle]="{ top: contextMenuPosition.y + 'px', left: contextMenuPosition.x + 'px' }"
  (click)="$event.stopPropagation()">
  <button type="button" (click)="onContextEdit()" [disabled]="!canEditVenda()">
    <i class="fas fa-pen"></i> Editar
  </button>
  <button type="button" (click)="onContextBaixa()" [disabled]="!canLancarBaixa()">
    <i class="fas fa-dollar-sign"></i> Baixa
  </button>
  <button type="button" (click)="onContextFechar()" [disabled]="!canFecharVendas()">
    <i class="fas fa-lock"></i> Fechar
  </button>
  <button type="button" (click)="onContextCancelarFechamento()" [disabled]="!canCancelarFechamento()">
    <i class="fas fa-unlock"></i> Cancelar Fechamento
  </button>
  <button type="button" (click)="onContextAuditoria()" [disabled]="!canAuditVenda()">
    <i class="fas fa-history"></i> Auditoria
  </button>
  <button type="button" class="danger" (click)="onContextExcluir()" [disabled]="!canDeleteVenda()">
    <i class="fas fa-trash"></i> Excluir
  </button>
</div>

<app-venda-modal
  [showModal]="showVendaModal"
  [venda]="selectedVenda"
  (close)="onVendaModalClose()"
  (saved)="onVendaSaved($event)">
</app-venda-modal>

<app-historico-auditoria
  *ngIf="selectedVendaForAudit"
  [entidade]="'vendas'"
  [entidadeId]="selectedVendaForAudit.id"
  [fieldLabels]="getAuditFieldLabels()"
  [showModal]="showAuditModal"
  (modalClosed)="closeAuditModal()">
</app-historico-auditoria>

<app-lancar-baixa-modal
  [showModal]="showBaixaModal"
  [venda]="selectedVendaForBaixa"
  (close)="closeBaixaModal()"
  (modalClosed)="onBaixaModalClosed()">
</app-lancar-baixa-modal>

<div
  class="confirmation-modal-overlay"
  *ngIf="showMassBaixaModal"
  (click)="massBaixaLoading ? null : closeMassBaixaModal()">
  <div class="confirmation-modal mass-baixa-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Processar baixas em massa</h3>
      <button
        type="button"
        class="close-btn"
        (click)="closeMassBaixaModal()"
        [attr.disabled]="massBaixaLoading ? 'disabled' : null">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>
        Serão processadas {{ selectedVendas.size }} venda(s).
        Apenas vendas com status
        <strong *ngFor="let status of massBaixaAllowedStatuses; let last = last">
          {{ getStatusLabel(status) }}<ng-container *ngIf="!last">, </ng-container>
        </strong>
        serão atualizadas automaticamente.
      </p>
      <div class="mass-baixa-form">
        <div class="form-field">
          <label for="massTipoBaixa">Tipo da baixa</label>
          <select
            id="massTipoBaixa"
            class="campo"
            [(ngModel)]="massBaixaForm.tipoDaBaixa"
            [ngModelOptions]="{ standalone: true }"
            [attr.disabled]="massBaixaLoading ? 'disabled' : null">
            <option *ngFor="let tipo of tiposBaixa" [value]="tipo">
              {{ tipo }}
            </option>
          </select>
        </div>
        <div class="form-field">
          <label for="massDataBaixa">Data da baixa</label>
          <input
            id="massDataBaixa"
            type="date"
            class="campo"
            [(ngModel)]="massBaixaForm.dataBaixa"
            [ngModelOptions]="{ standalone: true }"
            [attr.disabled]="massBaixaLoading ? 'disabled' : null">
        </div>
        <div class="form-field">
          <label for="massObservacao">Observação</label>
          <textarea
            id="massObservacao"
            class="campo"
            rows="3"
            placeholder="Opcional"
            [(ngModel)]="massBaixaForm.observacao"
            [ngModelOptions]="{ standalone: true }"
            [attr.disabled]="massBaixaLoading ? 'disabled' : null"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button
        class="btn btn-cancelar"
        type="button"
        (click)="closeMassBaixaModal()"
        [attr.disabled]="massBaixaLoading ? 'disabled' : null">
        Cancelar
      </button>
      <button
        class="btn btn-baixa"
        type="button"
        (click)="processarBaixasEmMassa()"
        [attr.disabled]="massBaixaLoading ? 'disabled' : null">
        <i class="fas" [ngClass]="massBaixaLoading ? 'fa-spinner fa-spin' : 'fa-check'"></i>
        {{ massBaixaLoading ? 'Processando...' : 'Processar baixas' }}
      </button>
    </div>
  </div>
</div>

<div class="confirmation-modal-overlay" *ngIf="showDeleteModal || showBulkDeleteModal" (click)="showBulkDeleteModal ? closeBulkDeleteModal() : onDeleteCancelled()">
  <div class="confirmation-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ showBulkDeleteModal ? 'Excluir vendas selecionadas' : 'Confirmação de Exclusão' }}</h3>
      <button type="button" class="close-btn" (click)="showBulkDeleteModal ? closeBulkDeleteModal() : onDeleteCancelled()" [attr.disabled]="bulkDeleteLoading ? 'disabled' : null">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p *ngIf="!showBulkDeleteModal">{{ deleteModalMessage }}</p>
      <p *ngIf="showBulkDeleteModal">Tem certeza que deseja excluir {{ selectedVendas.size }} venda(s) selecionadas?</p>
      <p class="warning-text">
        <i class="fas fa-exclamation-circle"></i>
        Esta ação não pode ser desfeita.
      </p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-cancelar" type="button" (click)="showBulkDeleteModal ? closeBulkDeleteModal() : onDeleteCancelled()" [attr.disabled]="showBulkDeleteModal && bulkDeleteLoading ? 'disabled' : null">
        Cancelar
      </button>
      <button
        class="btn btn-excluir"
        type="button"
        (click)="showBulkDeleteModal ? confirmBulkDelete() : onDeleteConfirmed()"
        [attr.disabled]="showBulkDeleteModal && bulkDeleteLoading ? 'disabled' : null">
        <i class="fas fa-trash"></i>
        {{ showBulkDeleteModal ? (bulkDeleteLoading ? 'Excluindo...' : 'Excluir') : 'Excluir' }}
      </button>
    </div>
  </div>
</div>
