<div class="ficha-tecnica-list-container">
  <header class="page-header">
    <div class="header-content">
      <h1>
        <span class="nav-icon">
          <svg width="22" height="22" fill="none" stroke="rgba(100,116,139,0.6)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        </span>
        Fichas T√©cnicas
      </h1>
      <div class="header-actions">
        @if (hasPermission(Permission.FICHA_TECNICA_CREATE)) {
          <a routerLink="/fichas-tecnicas/new" class="btn btn-primary">
            Nova Ficha T√©cnica
          </a>
        }
      </div>
    </div>
  </header>

  <!-- Filtros de Pesquisa -->
  <section class="filters-section">
    <div class="filters-container">
      <div class="filters-grid">
        <div class="filter-group">
          <label for="tipoDaFicha">Tipo de Ficha</label>
          <select id="tipoDaFicha" [(ngModel)]="searchFilters.tipoDaFicha" class="form-input" (change)="applyFilters()">
            <option value="">Todos</option>
            <option value="MAT√âRIA PRIMA">MAT√âRIA PRIMA</option>
            <option value="FITOTER√ÅPICO">FITOTER√ÅPICO</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="produto">Produto</label>
          <input
            id="produto"
            type="text"
            [(ngModel)]="searchFilters.produto"
            placeholder="Buscar por produto..."
            class="form-input"
            (input)="onProductSearch()"
          />
        </div>

        <div class="filter-group">
          <label for="codigoFormulaCerta">C√≥digo F√≥rmula Certa</label>
          <input
            id="codigoFormulaCerta"
            type="text"
            [(ngModel)]="searchFilters.codigoFormulaCerta"
            placeholder="Ex: 12345"
            class="form-input"
            (keyup.enter)="applyFilters()"
          />
        </div>

        <div class="filter-group">
          <label for="dataInicialAnalise">Data An√°lise In√≠cio</label>
          <input
            id="dataInicialAnalise"
            type="date"
            [(ngModel)]="searchFilters.dataInicialAnalise"
            class="form-input"
            (change)="applyFilters()"
          />
        </div>

        <div class="filter-group">
          <label for="dataFinalAnalise">Data An√°lise Fim</label>
          <input
            id="dataFinalAnalise"
            type="date"
            [(ngModel)]="searchFilters.dataFinalAnalise"
            class="form-input"
            (change)="applyFilters()"
          />
        </div>

        <div class="filter-group filter-actions">
          <label>&nbsp;</label>
          <div class="buttons-container">
            <button type="button" class="btn btn-primary" (click)="applyFilters()" [disabled]="loading()">
              Pesquisar
            </button>
            <button type="button" class="btn btn-secondary" (click)="clearFilters()" [disabled]="loading()">
              Limpar
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Estado de Carregamento -->
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Carregando fichas t√©cnicas...</p>
    </div>
  }

  <!-- Estado de Erro -->
  @if (error()) {
    <div class="error-state">
      <div class="error-message">
        <i class="icon">‚ö†Ô∏è</i>
        <p>{{ error() }}</p>
      </div>
      <button class="btn btn-primary" (click)="loadFichasTecnicas()">
        Tentar Novamente
      </button>
    </div>
  }

  <!-- Lista de Fichas T√©cnicas -->
  @if (!loading() && !error()) {
    <section class="results-section">
      <div class="results-header">
        <p class="results-count">
          Exibindo {{ fichasTecnicas().length }} de {{ totalItems }} fichas t√©cnicas
        </p>
      </div>

      @if (fichasTecnicas().length === 0) {
        <div class="empty-state">
          <i class="icon">üìã</i>
          <h3>Nenhuma ficha t√©cnica encontrada</h3>
          <p>N√£o h√° fichas t√©cnicas que correspondam aos filtros aplicados.</p>
          @if (hasPermission(Permission.FICHA_TECNICA_CREATE)) {
            <a routerLink="/fichas-tecnicas/new" class="btn btn-primary">
              Criar Primeira Ficha T√©cnica
            </a>
          }
        </div>
      } @else {
        <!-- Tabela de Fichas T√©cnicas -->
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Tipo da Ficha</th>
                <th>Produto</th>
                <th>Nome Cient√≠fico</th>
                <th>Revis√£o</th>
                <th>Data de An√°lise</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              @for (ficha of fichasTecnicas(); track ficha.id) {
                <tr>
                  <td>{{ ficha.codigoFormulaCerta }}</td>
                  <td>{{ ficha.tipoDaFicha || '-' }}</td>
                  <td class="product-cell">
                    <div class="product-info">
                      <span class="product-name">{{ ficha.produto }}</span>
                      @if (ficha.formulaMolecular) {
                        <span class="formula">{{ ficha.formulaMolecular }}</span>
                      }
                    </div>
                  </td>
                  <td>{{ ficha.nomeCientifico || '-' }}</td>
                  <td>{{ ficha.revisao || '-' }}</td>
                  <td>{{ formatDate(ficha.dataDeAnalise) }}</td>
                  <td>
                    <div class="action-buttons">
                      @if (hasPermission(Permission.FICHA_TECNICA_READ)) {
                        <button 
                          type="button"
                          class="btn btn-small btn-info"
                          title="Visualizar"
                          (click)="viewFicha(ficha)"
                        >
                          Visualizar
                        </button>
                      }
                      @if (hasPermission(Permission.FICHA_TECNICA_UPDATE)) {
                        <button 
                          type="button"
                          class="btn btn-small btn-primary"
                          title="Editar"
                          (click)="editFicha(ficha)"
                        >
                          Editar
                        </button>
                      }
                      <button 
                        type="button"
                        class="btn btn-small btn-secondary"
                        title="Imprimir"
                        (click)="printFicha(ficha)"
                      >
                        Imprimir
                      </button>
                      @if (hasPermission(Permission.FICHA_TECNICA_DELETE)) {
                        <button 
                          type="button"
                          class="btn btn-small btn-danger"
                          title="Excluir"
                          (click)="openDeleteModal(ficha)"
                        >
                          Excluir
                        </button>
                      }
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Pagina√ß√£o -->
        @if (totalPages > 1) {
          <div class="pagination-container">
            <div class="pagination">
              <button 
                class="btn-pagination"
                [disabled]="!hasPreviousPage"
                (click)="goToPage(currentPage - 1)"
              >
                ‚Äπ Anterior
              </button>

              @for (page of pageNumbers; track page) {
                <button 
                  class="btn-pagination"
                  [class.active]="page === currentPage"
                  (click)="goToPage(page)"
                >
                  {{ page }}
                </button>
              }

              <button 
                class="btn-pagination"
                [disabled]="!hasNextPage"
                (click)="goToPage(currentPage + 1)"
              >
                Pr√≥xima ‚Ä∫
              </button>
            </div>

            <div class="pagination-info">
              P√°gina {{ currentPage }} de {{ totalPages }}
            </div>
          </div>
        }
      }
    </section>
  }
</div>

<!-- Modal de Confirma√ß√£o de Exclus√£o -->
<app-confirmation-modal 
  [isVisible]="showDeleteModal" 
  title="Confirmar Exclus√£o" 
  message="Tem certeza de que deseja excluir esta ficha t√©cnica? Esta a√ß√£o n√£o pode ser desfeita." 
  confirmText="Excluir" 
  cancelText="Cancelar" 
  (confirmed)="confirmDelete()" 
  (cancelled)="closeDeleteModal()">
</app-confirmation-modal>