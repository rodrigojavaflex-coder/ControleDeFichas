<div class="ficha-tecnica-list-container">
  <header class="page-header">
    <div class="header-content">
      <h1>
        <span class="nav-icon">
          <svg width="22" height="22" fill="none" stroke="rgba(100,116,139,0.6)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        </span>
        Fichas T√©cnicas
      </h1>
      <div class="header-actions">
        @if (hasPermission(Permission.FICHA_TECNICA_CREATE)) {
    <a [routerLink]="['/fichas-tecnicas','new']" [queryParams]="searchFilters" class="btn btn-primary">
            Nova Ficha T√©cnica
          </a>
        }
      </div>
    </div>
  </header>

  <!-- Filtros de Pesquisa -->
  <section class="filters-section">
    <div class="filters-container">
      <div class="filters-grid">
        <div class="filter-group">
          <label for="tipoDaFicha">Tipo de Ficha</label>
          <select id="tipoDaFicha" [(ngModel)]="searchFilters.tipoDaFicha" class="form-input" (change)="applyFilters()">
            <option value="">Todos</option>
            <option value="MAT√âRIA PRIMA">MAT√âRIA PRIMA</option>
            <option value="FITOTER√ÅPICO">FITOTER√ÅPICO</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="produto">Produto</label>
          <input
            id="produto"
            type="text"
            [(ngModel)]="searchFilters.produto"
            placeholder="Buscar por produto..."
            class="form-input"
            (input)="onProductSearch()"
          />
        </div>

        <div class="filter-group">
          <label for="codigoFormulaCerta">C√≥digo F√≥rmula Certa</label>
          <input
            id="codigoFormulaCerta"
            type="text"
            [(ngModel)]="searchFilters.codigoFormulaCerta"
            placeholder="Ex: 12345"
            class="form-input"
            (keyup.enter)="applyFilters()"
          />
        </div>

        <div class="filter-group">
          <label for="dataInicialAnalise">Data An√°lise In√≠cio</label>
          <input
            id="dataInicialAnalise"
            type="date"
            [(ngModel)]="searchFilters.dataInicialAnalise"
            class="form-input"
            (change)="applyFilters()"
          />
        </div>

        <div class="filter-group">
          <label for="dataFinalAnalise">Data An√°lise Fim</label>
          <input
            id="dataFinalAnalise"
            type="date"
            [(ngModel)]="searchFilters.dataFinalAnalise"
            class="form-input"
            (change)="applyFilters()"
          />
        </div>

        <div class="filter-group filter-actions">
          <label>&nbsp;</label>
          <div class="buttons-container">
            <button type="button" class="btn btn-primary" (click)="applyFilters()" [disabled]="loading()">
              Pesquisar
            </button>
            <button type="button" class="btn btn-secondary" (click)="clearFilters()" [disabled]="loading()">
              Limpar
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Estado de Carregamento -->
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Carregando fichas t√©cnicas...</p>
    </div>
  }

  <!-- Estado de Erro -->
  @if (error()) {
    <div class="error-state">
      <div class="error-message">
        <i class="icon">‚ö†Ô∏è</i>
        <p>{{ error() }}</p>
      </div>
      <button class="btn btn-primary" (click)="loadFichasTecnicas()">
        Tentar Novamente
      </button>
    </div>
  }

  <!-- Lista de Fichas T√©cnicas -->
  @if (!loading() && !error()) {
    <section class="results-section">
      <div class="results-header">
        <p class="results-count">
          Exibindo {{ fichasTecnicas().length }} de {{ totalItems }} fichas t√©cnicas
        </p>
      </div>

      @if (fichasTecnicas().length === 0) {
        <div class="empty-state">
          <i class="icon">üìã</i>
          <h3>Nenhuma ficha t√©cnica encontrada</h3>
          <p>N√£o h√° fichas t√©cnicas que correspondam aos filtros aplicados.</p>
          @if (hasPermission(Permission.FICHA_TECNICA_CREATE)) {
      <a [routerLink]="['/fichas-tecnicas','new']" [queryParams]="searchFilters" class="btn btn-primary">
              Criar Primeira Ficha T√©cnica
            </a>
          }
        </div>
      } @else {
        <!-- Pagina√ß√£o (Posicionada acima da tabela) -->
        @if (totalPages > 1) {
          <div class="pagination-container">
            <div class="pagination">
              <button 
                class="btn-pagination"
                [disabled]="!hasPreviousPage"
                (click)="goToPage(currentPage - 1)"
              >
                ‚Äπ Anterior
              </button>

              @for (page of pageNumbers; track page) {
                <button 
                  class="btn-pagination"
                  [class.active]="page === currentPage"
                  (click)="goToPage(page)"
                >
                  {{ page }}
                </button>
              }

              <button 
                class="btn-pagination"
                [disabled]="!hasNextPage"
                (click)="goToPage(currentPage + 1)"
              >
                Pr√≥xima ‚Ä∫
              </button>
            </div>

            <div class="pagination-info">
              P√°gina {{ currentPage }} de {{ totalPages }}
            </div>
          </div>
        }

        <!-- Cards de Fichas T√©cnicas -->
        <div class="fichas-cards-container">
          @for (ficha of fichasTecnicas(); track ficha.id) {
            <div class="ficha-card">
              <div class="ficha-header" (click)="toggleExpand(ficha.id)" [title]="isExpanded(ficha.id) ? 'Ocultar Certificados' : 'Exibir Certificados'">
                <div class="ficha-title">
                  <h3>Ficha: {{ ficha.codigoFormulaCerta }} - <strong>{{ ficha.produto }}</strong> ({{ ficha.tipoDaFicha }})</h3>
                                    <div class="ficha-actions">
                    <!-- Menu de a√ß√µes (3 pontos) -->
                    <div class="dropdown-container" (click)="$event.stopPropagation()">
          <button type="button"
            class="btn btn-outline-secondary btn-sm dropdown-toggle-custom"
            (click)="toggleDropdown(ficha.id); !isExpanded(ficha.id) && toggleExpand(ficha.id)"
                              title="Exibir op√ß√µes da ficha t√©cnica">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                        </svg>
                        Op√ß√µes da Ficha
                      </button>
                      @if (isDropdownOpen(ficha.id)) {
                        <ul class="dropdown-menu-custom show">
                          @if (hasPermission(Permission.CERTIFICADO_CREATE)) {
                            <li><a class="dropdown-item" title="Adicionar um novo Certificado a ficha" (click)="novoCertificado(ficha); closeDropdown(ficha.id); $event.preventDefault()">Novo Certificado</a></li>
                          }
                          @if (hasPermission(Permission.FICHA_TECNICA_READ)) {
                            <li><a class="dropdown-item" title="Gerar o Relat√≥rio Ficha T√©cnica"  (click)="printFicha(ficha); closeDropdown(ficha.id); $event.preventDefault()">Imprimir Ficha</a></li>
                          }
                          @if (hasPermission(Permission.FICHA_TECNICA_UPDATE)) {
                            <li><a class="dropdown-item" title="Fazer Altera√ß√µes na Ficha T√©cnica" (click)="editFicha(ficha); closeDropdown(ficha.id); $event.preventDefault()">Editar Ficha</a></li>
                          }
                          @if (hasPermission(Permission.FICHA_TECNICA_AUDIT)) {
                            <li><a class="dropdown-item" title="Visualizar todo o Hist√≥rico de altera√ß√µes da Ficha T√©cnica" (click)="openAuditHistory(ficha); closeDropdown(ficha.id); $event.preventDefault()">Hist√≥rico de Auditoria</a></li>
                          }
                          @if (hasPermission(Permission.FICHA_TECNICA_DELETE)) {
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" title="Remover a Ficha T√©cnica" (click)="openDeleteModal(ficha); closeDropdown(ficha.id); $event.preventDefault()">
                              <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5V6z"/>
                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                              </svg>
                              Excluir Ficha
                            </a></li>
                          }
                        </ul>
                      }
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Conte√∫do expandido com certificados -->
              @if (isExpanded(ficha.id)) {
                <div class="ficha-content">
                  @if (isLoadingCertificados(ficha.id)) {
                    <div class="certificado-loading">
                      <div class="spinner small"></div>
                      <span>Carregando certificados...</span>
                    </div>
                  } @else if (getCertificados(ficha.id).length === 0) {
                    <div class="certificado-empty">
                      <span>Nenhum certificado encontrado para esta ficha t√©cnica.</span>
                      @if (hasPermission(Permission.CERTIFICADO_CREATE)) {
                        <button 
                          type="button"
                          class="btn btn-small btn-success"
                          (click)="novoCertificado(ficha)"
                        >
                          Criar Primeiro Certificado
                        </button>
                      }
                    </div>
                  } @else {
                    @for (certificado of getCertificados(ficha.id); track certificado.id) {
                      <div class="certificado-card">
                        <details open>
                          <summary class="certificado-header">
                            <div class="certificado-title">
                              <span>Certificado: {{ certificado.numeroDoCertificado }}</span>
                              <div class="certificado-actions" (click)="$event.stopPropagation()">
                                <!-- A√ß√µes do Certificado - Dropdown -->
                                <div class="dropdown-container" (click)="$event.stopPropagation()">
                                  <button type="button"
                                    class="btn btn-outline-secondary btn-sm dropdown-toggle-custom"
                                    (click)="toggleCertDropdown(certificado.id)"
                                    title="Mais a√ß√µes">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                      <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                    </svg>
                                    Op√ß√µes do Certificado
                                  </button>
                                  @if (isCertDropdownOpen(certificado.id)) {
                                    <ul class="dropdown-menu-custom show">
                                      @if (hasPermission(Permission.CERTIFICADO_READ)) {
                                        <li><a class="dropdown-item" (click)="printCertificado(certificado); closeCertDropdown(certificado.id); $event.preventDefault()">Imprimir Certificado</a></li>
                                      }
                                      @if (hasPermission(Permission.CERTIFICADO_UPDATE)) {
                                        <li><a class="dropdown-item" (click)="editCertificado(certificado); closeCertDropdown(certificado.id); $event.preventDefault()">Editar Certificado</a></li>
                                      }
                                      @if (hasPermission(Permission.CERTIFICADO_AUDIT)) {
                                        <li><a class="dropdown-item" (click)="openCertAuditHistory(certificado); closeCertDropdown(certificado.id); $event.preventDefault()">Hist√≥rico de Auditoria</a></li>
                                      }
                                      @if (hasPermission(Permission.CERTIFICADO_DELETE)) {
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                          <a class="dropdown-item text-danger" title="Excluir Certificado" (click)="openDeleteCertModal(certificado); closeCertDropdown(certificado.id); $event.preventDefault()">
                                            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                                              <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5V6z"/>
                                              <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                            </svg>
                                            Excluir Certificado
                                          </a>
                                        </li>
                                      }
                                    </ul>
                                  }
                                </div>
                              </div>
                            </div>
                          </summary>
                          <div class="certificado-body certificados-grid">
                            <!-- Coluna 1: Detalhes b√°sicos -->
                            <div class="col-details">
                              <p><strong>N√∫mero:</strong> {{ certificado.numeroDoCertificado }}</p>
                              <p><strong>Lote:</strong> {{ certificado.loteDoCertificado }}</p>
                              <p><strong>Fornecedor:</strong> {{ certificado.fornecedor }}</p>
                              <p><strong>Pedido:</strong> {{ certificado.numeroDoPedido }}</p>
                            </div>
                            <!-- Coluna 3: M√©tricas e datas -->
                            <div class="col-metrics">
                              <p><strong>Quantidade:</strong> {{ certificado.quantidade }}</p>
                              <p><strong>Data Cert.:</strong> {{ formatDate(certificado.dataCertificado) }}</p>
                              <p><strong>Fabrica√ß√£o:</strong> {{ formatDate(certificado.dataDeFabricacao) }}</p>
                              <p><strong>Validade:</strong> {{ formatDate(certificado.dataDeValidade) }}</p>
                            </div>
                            <!-- Coluna 3: Laudos -->
                            <div class="col-laudos">
                              @if (isLoadingLaudos(certificado.id)) {
                                <div class="laudos-loading"><div class="spinner small"></div><span>Carregando laudos...</span></div>
                              } @else {
                                <div class="laudos-section">
                                  <h4 class="laudos-title">Laudos do Certificado</h4>
                                  <div class="laudos-list">
                                    @for (laudo of getLaudos(certificado.id); track laudo.id) {
                                      <div class="laudo-item">
                                        <a href="#" (click)="$event.preventDefault(); openLaudo(certificado.id, laudo.id)">{{ laudo.nomeArquivo }}</a>
                                        @if (hasPermission(Permission.CERTIFICADO_UPDATE)) {
                                          <button type="button" class="btn btn-small btn-danger" (click)="confirmRemoveLaudo(certificado.id, laudo.id, laudo.nomeArquivo)" title="Remover o laudo do certificado">Excluir Laudo</button>
                                        }
                                      </div>
                                    }
                                  </div>
                                  @if (hasPermission(Permission.CERTIFICADO_UPDATE)) {
                                    <div class="upload-section">
                                      <label title="Selecione um o laudo em .PDF para gravar o laudo do certificado" class="btn btn-small btn-success upload-laudo-btn">
                                        Incluir Laudo
                                        <input type="file" accept="application/pdf" (change)="onLaudoFileSelected(certificado.id, $event)" />
                                      </label>
                                    </div>
                                  }
                                </div>
                              }
                            </div>
                          </div>
                        </details>
                      </div>
                    }
                  }

                  <!-- Bot√£o Novo Certificado -->
                  @if (hasPermission(Permission.CERTIFICADO_CREATE)) {
                    <div class="add-certificado-container">
                      <button type="button" class="btn btn-success" (click)="novoCertificado(ficha)">
                        Novo Certificado
                      </button>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }
    </section>
  }
</div>

<!-- Modal de Confirma√ß√£o de Exclus√£o -->
<app-confirmation-modal 
  [isVisible]="showDeleteModal" 
  title="Confirmar Exclus√£o" 
  [message]="deleteMessage" 
  confirmText="Excluir" 
  cancelText="Cancelar" 
  (confirmed)="confirmDelete()" 
  (cancelled)="closeDeleteModal()">
</app-confirmation-modal>

<!-- Modal de Confirma√ß√£o de Exclus√£o de Certificado -->
<app-confirmation-modal
  [isVisible]="showDeleteCertModal"
  title="Confirmar Exclus√£o"
  [message]="deleteCertMessageCert"
  confirmText="Excluir"
  cancelText="Cancelar"
  (confirmed)="confirmDeleteCertificado()"
  (cancelled)="closeDeleteCertModal()"
>
</app-confirmation-modal>

<!-- Modal de Confirma√ß√£o de Exclus√£o de Laudo -->
<app-confirmation-modal
  [isVisible]="showDeleteLaudoModal"
  title="Confirmar Exclus√£o"
  [message]="deleteLaudoMessage"
  confirmText="Excluir"
  cancelText="Cancelar"
  (confirmed)="confirmDeleteLaudo()"
  (cancelled)="closeDeleteLaudoModal()"
>
</app-confirmation-modal>

<!-- Modal de hist√≥rico de auditoria -->
<app-historico-auditoria
  *ngIf="selectedFichaForAudit"
  [entidade]="'fichas_tecnicas'"
  [entidadeId]="selectedFichaForAudit.id"
  [fieldLabels]="{
    produto: 'Produto',
    tipoDaFicha: 'Tipo da Ficha',
    codigoFormulaCerta: 'C√≥digo F√≥rmula Certa',
    principioAtivo: 'Princ√≠pio Ativo',
    concentracao: 'Concentra√ß√£o',
    formaFarmaceutica: 'Forma Farmac√™utica',
    viaAdministracao: 'Via Administra√ß√£o',
    indicacao: 'Indica√ß√£o',
    posologia: 'Posologia',
    conservacao: 'Conserva√ß√£o',
    validade: 'Validade',
    fabricante: 'Fabricante',
    registroMS: 'Registro MS',
    bula: 'Bula',
    observacoes: 'Observa√ß√µes'
  }"
  [showModal]="showAuditModal"
  (modalClosed)="closeAuditModal()">
</app-historico-auditoria>
<!-- Modal de hist√≥rico de auditoria de certificado -->
<app-historico-auditoria
  *ngIf="selectedCertForAudit"
  [entidade]="'certificados'"
  [entidadeId]="selectedCertForAudit.id"
  [fieldLabels]="{
    numeroDoCertificado: 'N√∫mero Certificado',
    loteDoCertificado: 'Lote',
    fornecedor: 'Fornecedor',
    numeroDoPedido: 'N√∫mero do Pedido',
    quantidade: 'Quantidade',
    dataCertificado: 'Data Certificado',
    dataDeFabricacao: 'Data Fabrica√ß√£o',
    dataDeValidade: 'Data de Validade',
    avaliacaoDoLaudo: 'Avalia√ß√£o do Laudo',
    observacao01: 'Observa√ß√£o'
  }"
  [showModal]="showCertAuditModal"
  (modalClosed)="closeCertAuditModal()">
</app-historico-auditoria>