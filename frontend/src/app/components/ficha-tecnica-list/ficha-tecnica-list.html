<div class="ficha-tecnica-list-container">
  <header class="page-header">
    <div class="header-content">
      <h1>
        <span class="nav-icon">
          <svg width="22" height="22" fill="none" stroke="rgba(100,116,139,0.6)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        </span>
        Fichas T√©cnicas
      </h1>
      <div class="header-actions">
        @if (hasPermission(Permission.FICHA_TECNICA_CREATE)) {
    <a [routerLink]="['/fichas-tecnicas','new']" [queryParams]="searchFilters" class="btn btn-primary">
            Nova Ficha T√©cnica
          </a>
        }
      </div>
    </div>
  </header>

  <!-- Filtros de Pesquisa -->
  <section class="filters-section">
    <div class="filters-container">
      <div class="filters-grid">
        <div class="filter-group">
          <label for="tipoDaFicha">Tipo de Ficha</label>
          <select id="tipoDaFicha" [(ngModel)]="searchFilters.tipoDaFicha" class="form-input" (change)="applyFilters()">
            <option value="">Todos</option>
            <option value="MAT√âRIA PRIMA">MAT√âRIA PRIMA</option>
            <option value="FITOTER√ÅPICO">FITOTER√ÅPICO</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="produto">Produto</label>
          <input
            id="produto"
            type="text"
            [(ngModel)]="searchFilters.produto"
            placeholder="Buscar por produto..."
            class="form-input"
            (input)="onProductSearch()"
          />
        </div>

        <div class="filter-group">
          <label for="codigoFormulaCerta">C√≥digo F√≥rmula Certa</label>
          <input
            id="codigoFormulaCerta"
            type="text"
            [(ngModel)]="searchFilters.codigoFormulaCerta"
            placeholder="Ex: 12345"
            class="form-input"
            (keyup.enter)="applyFilters()"
          />
        </div>

        <div class="filter-group">
          <label for="dataInicialAnalise">Data An√°lise In√≠cio</label>
          <input
            id="dataInicialAnalise"
            type="date"
            [(ngModel)]="searchFilters.dataInicialAnalise"
            class="form-input"
            (change)="applyFilters()"
          />
        </div>

        <div class="filter-group">
          <label for="dataFinalAnalise">Data An√°lise Fim</label>
          <input
            id="dataFinalAnalise"
            type="date"
            [(ngModel)]="searchFilters.dataFinalAnalise"
            class="form-input"
            (change)="applyFilters()"
          />
        </div>

        <div class="filter-group filter-actions">
          <label>&nbsp;</label>
          <div class="buttons-container">
            <button type="button" class="btn btn-primary" (click)="applyFilters()" [disabled]="loading()">
              Pesquisar
            </button>
            <button type="button" class="btn btn-secondary" (click)="clearFilters()" [disabled]="loading()">
              Limpar
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Estado de Carregamento -->
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Carregando fichas t√©cnicas...</p>
    </div>
  }

  <!-- Estado de Erro -->
  @if (error()) {
    <div class="error-state">
      <div class="error-message">
        <i class="icon">‚ö†Ô∏è</i>
        <p>{{ error() }}</p>
      </div>
      <button class="btn btn-primary" (click)="loadFichasTecnicas()">
        Tentar Novamente
      </button>
    </div>
  }

  <!-- Lista de Fichas T√©cnicas -->
  @if (!loading() && !error()) {
    <section class="results-section">
      <div class="results-header">
        <p class="results-count">
          Exibindo {{ fichasTecnicas().length }} de {{ totalItems }} fichas t√©cnicas
        </p>
      </div>

      @if (fichasTecnicas().length === 0) {
        <div class="empty-state">
          <i class="icon">üìã</i>
          <h3>Nenhuma ficha t√©cnica encontrada</h3>
          <p>N√£o h√° fichas t√©cnicas que correspondam aos filtros aplicados.</p>
          @if (hasPermission(Permission.FICHA_TECNICA_CREATE)) {
      <a [routerLink]="['/fichas-tecnicas','new']" [queryParams]="searchFilters" class="btn btn-primary">
              Criar Primeira Ficha T√©cnica
            </a>
          }
        </div>
      } @else {
        <!-- Pagina√ß√£o (Posicionada acima da tabela) -->
        @if (totalPages > 1) {
          <div class="pagination-container">
            <div class="pagination">
              <button 
                class="btn-pagination"
                [disabled]="!hasPreviousPage"
                (click)="goToPage(currentPage - 1)"
              >
                ‚Äπ Anterior
              </button>

              @for (page of pageNumbers; track page) {
                <button 
                  class="btn-pagination"
                  [class.active]="page === currentPage"
                  (click)="goToPage(page)"
                >
                  {{ page }}
                </button>
              }

              <button 
                class="btn-pagination"
                [disabled]="!hasNextPage"
                (click)="goToPage(currentPage + 1)"
              >
                Pr√≥xima ‚Ä∫
              </button>
            </div>

            <div class="pagination-info">
              P√°gina {{ currentPage }} de {{ totalPages }}
            </div>
          </div>
        }

        <!-- Cards de Fichas T√©cnicas -->
        <div class="fichas-cards-container">
          @for (ficha of fichasTecnicas(); track ficha.id) {
            <div class="ficha-card">
              <div class="ficha-header" (click)="toggleExpand(ficha.id)" [title]="isExpanded(ficha.id) ? 'Ocultar Certificados' : 'Exibir Certificados'">
                <div class="ficha-title">
                  <h3>Ficha: {{ ficha.codigoFormulaCerta }} - {{ ficha.produto }} ({{ ficha.tipoDaFicha }})</h3>
                  <div class="ficha-actions" (click)="$event.stopPropagation()">
                    @if (hasPermission(Permission.FICHA_TECNICA_READ)) {
                      <button 
                        type="button"
                        class="btn btn-small btn-info"
                        title="Imprimir Ficha T√©cnica"
                        (click)="printFicha(ficha)"
                      >
                        Imprimir Ficha T√©cnica
                      </button>
                    }
                    @if (hasPermission(Permission.FICHA_TECNICA_UPDATE)) {
                      <button 
                        type="button"
                        class="btn btn-small btn-primary"
                        title="Editar Ficha"
                        (click)="editFicha(ficha)"
                      >
                        Editar Ficha
                      </button>
                    }
                    @if (hasPermission(Permission.FICHA_TECNICA_DELETE)) {
                      <button 
                        type="button"
                        class="btn btn-small btn-danger"
                        title="Excluir Ficha"
                        (click)="openDeleteModal(ficha)"
                      >
                        Excluir Ficha
                      </button>
                    }
                    @if (hasPermission(Permission.CERTIFICADO_CREATE)) {
                      <button type="button" class="btn btn-small btn-success" title="Novo Certificado" (click)="novoCertificado(ficha)">
                        Novo Certificado
                      </button>
                    }
                  </div>
                </div>
              </div>
              
              <!-- Conte√∫do expandido com certificados -->
              @if (isExpanded(ficha.id)) {
                <div class="ficha-content">
                  @if (isLoadingCertificados(ficha.id)) {
                    <div class="certificado-loading">
                      <div class="spinner small"></div>
                      <span>Carregando certificados...</span>
                    </div>
                  } @else if (getCertificados(ficha.id).length === 0) {
                    <div class="certificado-empty">
                      <span>Nenhum certificado encontrado para esta ficha t√©cnica.</span>
                      @if (hasPermission(Permission.CERTIFICADO_CREATE)) {
                        <button 
                          type="button"
                          class="btn btn-small btn-success"
                          (click)="novoCertificado(ficha)"
                        >
                          Criar Primeiro Certificado
                        </button>
                      }
                    </div>
                  } @else {
                    @for (certificado of getCertificados(ficha.id); track certificado.id) {
                      <div class="certificado-card">
                        <details open>
                          <summary class="certificado-header">
                            <div class="certificado-title">
                              <span>Certificado: {{ certificado.numeroDoCertificado }}</span>
                              <div class="certificado-actions" (click)="$event.stopPropagation()">
                                @if (hasPermission(Permission.CERTIFICADO_READ)) {
                                  <button type="button" class="btn btn-small btn-info" title="Imprimir Certificado" (click)="printCertificado(certificado)">Imprimir Certificado</button>
                                }
                                @if (hasPermission(Permission.CERTIFICADO_UPDATE)) {
                                  <button type="button" class="btn btn-small btn-primary" title="Editar Certificado" (click)="editCertificado(certificado)">Editar Certificado</button>
                                }
                                @if (hasPermission(Permission.CERTIFICADO_DELETE)) {
                                  <button type="button" class="btn btn-small btn-danger" title="Excluir Certificado" (click)="openDeleteCertModal(certificado)">Excluir Certificado</button>
                                }
                              </div>
                            </div>
                          </summary>
                          <div class="certificado-body certificados-grid">
                            <!-- Coluna 1: Detalhes b√°sicos -->
                            <div class="col-details">
                              <p><strong>N√∫mero:</strong> {{ certificado.numeroDoCertificado }}</p>
                              <p><strong>Lote:</strong> {{ certificado.loteDoCertificado }}</p>
                              <p><strong>Fornecedor:</strong> {{ certificado.fornecedor }}</p>
                              <p><strong>Pedido:</strong> {{ certificado.numeroDoPedido }}</p>
                            </div>
                            <!-- Coluna 3: M√©tricas e datas -->
                            <div class="col-metrics">
                              <p><strong>Quantidade:</strong> {{ certificado.quantidade }}</p>
                              <p><strong>Data Cert.:</strong> {{ formatDate(certificado.dataCertificado) }}</p>
                              <p><strong>Fabrica√ß√£o:</strong> {{ formatDate(certificado.dataDeFabricacao) }}</p>
                              <p><strong>Validade:</strong> {{ formatDate(certificado.dataDeValidade) }}</p>
                            </div>
                            <!-- Coluna 3: Laudos -->
                            <div class="col-laudos">
                              @if (isLoadingLaudos(certificado.id)) {
                                <div class="laudos-loading"><div class="spinner small"></div><span>Carregando laudos...</span></div>
                              } @else {
                                <div class="laudos-section">
                                  <h4 class="laudos-title">Laudos do Certificado</h4>
                                  <div class="laudos-list">
                                    @for (laudo of getLaudos(certificado.id); track laudo.id) {
                                      <div class="laudo-item">
                                        <a href="#" (click)="$event.preventDefault(); openLaudo(certificado.id, laudo.id)">{{ laudo.nomeArquivo }}</a>
                                        @if (hasPermission(Permission.CERTIFICADO_UPDATE)) {
                                          <button type="button" class="btn btn-small btn-danger" (click)="confirmRemoveLaudo(certificado.id, laudo.id, laudo.nomeArquivo)">Excluir Laudo</button>
                                        }
                                      </div>
                                    }
                                  </div>
                                  @if (hasPermission(Permission.CERTIFICADO_UPDATE)) {
                                    <div class="upload-section">
                                      <label class="btn btn-small btn-success upload-laudo-btn">
                                        Enviar Laudo
                                        <input type="file" accept="application/pdf" (change)="onLaudoFileSelected(certificado.id, $event)" />
                                      </label>
                                    </div>
                                  }
                                </div>
                              }
                            </div>
                          </div>
                        </details>
                      </div>
                    }
                  }

                  <!-- Bot√£o Novo Certificado -->
                  @if (hasPermission(Permission.CERTIFICADO_CREATE)) {
                    <div class="add-certificado-container">
                      <button type="button" class="btn btn-success" (click)="novoCertificado(ficha)">
                        Novo Certificado
                      </button>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }
    </section>
  }
</div>

<!-- Modal de Confirma√ß√£o de Exclus√£o -->
<app-confirmation-modal 
  [isVisible]="showDeleteModal" 
  title="Confirmar Exclus√£o" 
  [message]="deleteMessage" 
  confirmText="Excluir" 
  cancelText="Cancelar" 
  (confirmed)="confirmDelete()" 
  (cancelled)="closeDeleteModal()">
</app-confirmation-modal>

<!-- Modal de Confirma√ß√£o de Exclus√£o de Certificado -->
<app-confirmation-modal
  [isVisible]="showDeleteCertModal"
  title="Confirmar Exclus√£o"
  [message]="deleteCertMessageCert"
  confirmText="Excluir"
  cancelText="Cancelar"
  (confirmed)="confirmDeleteCertificado()"
  (cancelled)="closeDeleteCertModal()"
>
</app-confirmation-modal>

<!-- Modal de Confirma√ß√£o de Exclus√£o de Laudo -->
<app-confirmation-modal
  [isVisible]="showDeleteLaudoModal"
  title="Confirmar Exclus√£o"
  [message]="deleteLaudoMessage"
  confirmText="Excluir"
  cancelText="Cancelar"
  (confirmed)="confirmDeleteLaudo()"
  (cancelled)="closeDeleteLaudoModal()"
>
</app-confirmation-modal>