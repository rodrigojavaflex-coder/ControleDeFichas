<ng-container *ngIf="canViewBaixas(); else noPermission">
  <div class="baixas-page">
    <section *ngIf="error" class="state-card error">
      <p>{{ error }}</p>
      <button class="btn btn-primario" type="button" (click)="loadBaixas()">Tentar novamente</button>
    </section>

    <section class="results-card" *ngIf="!error">
      <div class="results-header">
        <div class="header-actions">
          <button class="btn btn-baixa" type="button" (click)="abrirModalBaixaSelecionada()">
            <i class="fas fa-dollar-sign"></i>
            Baixa
          </button>
          <button class="btn btn-imprimir" type="button" (click)="imprimirRelatorio()" [attr.disabled]="(loading || items.length === 0) ? 'disabled' : null">
            <i class="fas fa-print"></i>
            Imprimir
          </button>
        </div>
        <p class="results-info" *ngIf="totalItems !== undefined">
          {{ totalItems }} baixa(s) encontrada(s){{ totalItems !== items.length ? ' (mostrando ' + items.length + ' nesta página)' : '' }}
        </p>
      </div>

      <div class="filters-inline">
        <div
          class="filters-panel-top"
          role="button"
          tabindex="0"
          (click)="onContainerClick($event)"
          (keydown)="onFiltersToggleKey($event)">
          <div class="filters-controls">
            <button
              type="button"
              class="filters-toggle btn btn-toggle-filtros"
              (click)="toggleFiltersVisibility(); $event.stopPropagation()"
              (mousedown)="$event.stopPropagation()">
              <span>{{ filtersPanelOpen ? 'Fechar filtros' : 'Abrir filtros' }}</span>
              <span class="filters-count" *ngIf="appliedFilters.length">
                {{ appliedFilters.length }}
              </span>
              <i
                class="fas"
                [class.fa-chevron-up]="filtersPanelOpen"
                [class.fa-chevron-down]="!filtersPanelOpen"></i>
            </button>
            <!-- Área de filtros aplicados melhorada -->
            <div
              class="applied-filters-container"
              *ngIf="appliedFilters.length">
              
              <!-- Contador de resultados -->
              <div class="results-count" *ngIf="totalItems !== undefined" (click)="$event.stopPropagation()">
                <i class="fas fa-filter"></i>
                <span>{{ totalItems }} resultado(s)</span>
              </div>
              
              <!-- Container com scroll horizontal -->
              <div class="applied-filters-wrapper">
                <div class="applied-filters-list">
                  <!-- Filtros de texto -->
                  <ng-container *ngFor="let filter of appliedFilters">
                    <span 
                      class="filter-chip" 
                      [class.filter-chip-multiple]="isMultipleFilter(filter.key)"
                      [title]="filter.value">
                      <i class="fas" [ngClass]="getFilterIcon(filter.key)"></i>
                      <strong>{{ filter.label }}:</strong> 
                      <span class="filter-value">{{ formatFilterValue(filter) }}</span>
                      <button
                        class="chip-remove"
                        type="button"
                        (click)="clearAppliedFilter(filter.key); $event.stopPropagation()"
                        aria-label="Remover filtro {{ filter.label }}">
                        <i class="fas fa-times"></i>
                      </button>
                    </span>
                  </ng-container>
                </div>
              </div>
              
              <!-- Botão limpar todos -->
              <button
                class="btn-clear-all"
                type="button"
                (click)="clearFilters(); $event.stopPropagation()"
                title="Limpar todos os filtros">
                <i class="fas fa-eraser"></i>
                Limpar todos
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="inline-loading" *ngIf="loading">
        <div class="spinner"></div>
        <span>Atualizando lista de baixas...</span>
      </div>

      <ng-container *ngIf="!loading">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Data baixa</th>
                <th>Protocolo</th>
                <th>Cliente</th>
                <th>Unidade</th>
                <th>Comprado em</th>
                <th>Tipo</th>
                <th>Valor</th>
                <th>Observação</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="items.length === 0">
                <td colspan="8" class="empty-state">
                  Nenhuma baixa encontrada para os filtros selecionados.
                </td>
              </tr>
              <tr
                *ngFor="let baixa of items"
                (click)="toggleSelectBaixa(baixa)"
                [class.row-selected]="isBaixaSelected(baixa)">
                <td>{{ baixa.dataBaixa | date: 'dd/MM/yyyy' }}</td>
                <td>{{ baixa.venda?.protocolo || '-' }}</td>
                <td>{{ getClienteNome(baixa.venda) }}</td>
                <td>{{ baixa.venda?.unidade || '-' }}</td>
                <td>{{ getOrigemLabel(baixa.venda?.origem) }}</td>
                <td>{{ baixa.tipoDaBaixa }}</td>
                <td>{{ formatCurrency(baixa.valorBaixa) }}</td>
                <td>{{ baixa.observacao || '-' }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="pagination" *ngIf="totalPages > 1">
          <button class="btn btn-sm btn-cancelar" (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1 || loading">
            <i class="fas fa-chevron-left"></i>
            Anterior
          </button>

          <span class="page-info">
            Página {{ currentPage }} de {{ totalPages }}
          </span>

          <button class="btn btn-sm btn-cancelar" (click)="onPageChange(currentPage + 1)" [disabled]="currentPage === totalPages || loading">
            Próxima
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </ng-container>
    </section>
    <app-lancar-baixa-modal
      [showModal]="showBaixaModal"
      [venda]="selectedVendaForBaixa"
      (close)="closeBaixaModal()"
      (modalClosed)="onBaixaModalClosed()">
    </app-lancar-baixa-modal>
  </div>

  <!-- Modal de Filtros -->
  <div class="modal-overlay" *ngIf="filtersPanelOpen" (click)="toggleFiltersVisibility()">
    <div class="modal-conteudo modal-filtros" (click)="$event.stopPropagation()">
      <div class="modal-cabecalho">
        <h3 class="modal-titulo">Filtros de Baixas</h3>
        <button type="button" class="modal-fechar" (click)="toggleFiltersVisibility()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-corpo">
        <div class="filters-grid">
          <!-- Primeira linha: Data da Baixa -->
          <div class="filter-group date-range-field">
            <app-date-range-filter
              label="Data da Baixa"
              startLabel="Início"
              endLabel="Fim"
              [start]="dataInicialFilter"
              [end]="dataFinalFilter"
              (rangeChange)="onPeriodoRangeChangeModal($event)">
            </app-date-range-filter>
          </div>

          <!-- Segunda linha: Protocolo, Cliente -->
          <div class="filter-group">
            <label for="protocoloFilterModal" class="label-campo">Protocolo</label>
            <input
              id="protocoloFilterModal"
              type="text"
              [(ngModel)]="protocoloFilter"
              placeholder="Buscar por protocolo..."
              class="campo"
              (keyup.enter)="applyFilters()">
          </div>

          <div class="filter-group">
            <label for="clienteFilterModal" class="label-campo">Cliente</label>
            <input
              id="clienteFilterModal"
              type="text"
              [(ngModel)]="clienteFilter"
              placeholder="Buscar por cliente..."
              class="campo"
              (keyup.enter)="applyFilters()">
          </div>

          <!-- Terceira linha: Comprado em, Unidade -->
          <div class="filter-group">
            <label class="label-campo">Comprado em</label>
            <app-multi-select-dropdown
              [(ngModel)]="origemFilter"
              [options]="getOrigemOptions()"
              placeholder="Selecione as origens..."
              selectAllLabel="Marcar todas"
              deselectAllLabel="Desmarcar todas">
            </app-multi-select-dropdown>
          </div>

          <div class="filter-group">
            <label class="label-campo">Unidade</label>
            <app-multi-select-dropdown
              [(ngModel)]="unidadeFilter"
              [options]="getUnidadeOptions()"
              [disabled]="unidadeDisabled"
              placeholder="Selecione as unidades..."
              selectAllLabel="Marcar todas"
              deselectAllLabel="Desmarcar todas">
            </app-multi-select-dropdown>
          </div>

          <!-- Quarta linha: Valor da baixa -->
          <div class="filter-group value-range-group">
            <label class="label-campo">Valor da baixa</label>
            <div class="range-fields">
              <input
                id="valorMinModal"
                type="text"
                class="campo"
                [(ngModel)]="valorMinFilter"
                (blur)="onValorBlur('min')"
                placeholder="Mínimo"
                (keyup.enter)="applyFilters()">
              <span class="range-separator">até</span>
              <input
                id="valorMaxModal"
                type="text"
                class="campo"
                [(ngModel)]="valorMaxFilter"
                (blur)="onValorBlur('max')"
                placeholder="Máximo"
                (keyup.enter)="applyFilters()">
            </div>
          </div>
        </div>
      </div>

      <div class="modal-rodape">
        <button
          type="button"
          class="botao botao-fantasma"
          (click)="clearFilters()">
          <i class="fas fa-eraser"></i>
          Limpar Filtros
        </button>
        <button
          type="button"
          class="botao botao-primario"
          (click)="applyFilters()">
          <i class="fas fa-filter"></i>
          Aplicar Filtros
        </button>
      </div>
    </div>
  </div>
</ng-container>

<ng-template #noPermission>
  <div class="state-card error">
    <p>Você não possui permissão para visualizar esta página.</p>
  </div>
</ng-template>
