<ng-container *ngIf="canViewBaixas(); else noPermission">
  <div class="baixas-page">
    <section *ngIf="error" class="state-card error">
      <p>{{ error }}</p>
      <button class="btn btn-primario" type="button" (click)="loadBaixas()">Tentar novamente</button>
    </section>

    <section class="results-card" *ngIf="!error">
      <div class="results-header">
        <div class="header-actions">
          <button class="btn btn-baixa" type="button" (click)="abrirModalBaixaSelecionada()">
            <i class="fas fa-dollar-sign"></i>
            Baixa
          </button>
          <button class="btn btn-imprimir" type="button" (click)="imprimirRelatorio()" [attr.disabled]="(loading || items.length === 0) ? 'disabled' : null">
            <i class="fas fa-print"></i>
            Imprimir
          </button>
        </div>
        <p class="results-info">{{ items.length }} baixas encontradas nesta página</p>
      </div>

      <div class="filters-inline">
        <div
          class="filters-panel-top"
          role="button"
          tabindex="0"
          (click)="toggleFiltersVisibility()"
          (keydown)="onFiltersToggleKey($event)">
          <div class="filters-controls">
            <div class="filters-toggle btn btn-toggle-filtros">
              <span>{{ filtersPanelOpen ? 'Ocultar filtros' : 'Mostrar filtros' }}</span>
              <span class="filters-count" *ngIf="appliedFilters.length">
                {{ appliedFilters.length }}
              </span>
              <i
                class="fas"
                [class.fa-chevron-up]="filtersPanelOpen"
                [class.fa-chevron-down]="!filtersPanelOpen"></i>
            </div>
            <div
              class="applied-filters-inline"
              *ngIf="appliedFilters.length"
              (click)="$event.stopPropagation()"
              (keydown)="$event.stopPropagation()">
              <div class="applied-filters-list">
                <span class="filter-chip" *ngFor="let filter of appliedFilters">
                  <strong>{{ filter.label }}:</strong> {{ filter.value }}
                  <button
                    class="chip-remove"
                    type="button"
                    (click)="clearAppliedFilter(filter.key); $event.stopPropagation()"
                    aria-label="Remover filtro {{ filter.label }}">
                    ×
                  </button>
                </span>
              </div>
            </div>
          </div>
        </div>

        <div class="filters" *ngIf="filtersPanelOpen">
          <div class="filter-group">
            <label for="protocolo">Protocolo</label>
            <input
              id="protocolo"
              type="text"
              class="form-control"
              [(ngModel)]="protocoloFilter"
             
              placeholder="Buscar por protocolo">
          </div>

          <div class="filter-group">
            <label for="cliente">Cliente</label>
            <input
              id="cliente"
              type="text"
              class="form-control"
              [(ngModel)]="clienteFilter"
             
              placeholder="Buscar por cliente"
              (keyup.enter)="onFilterChange()">
          </div>

          <div class="filter-group date-field date-range-field">
            <app-date-range-filter
              label="Data da Baixa"
              startLabel="Início"
              endLabel="Fim"
              [start]="dataInicialFilter"
              [end]="dataFinalFilter"
              (rangeChange)="onPeriodoRangeChange($event)">
            </app-date-range-filter>
          </div>

          <div class="filter-group">
            <label for="unidade">Unidade</label>
            <select
              id="unidade"
              class="form-control"
              [(ngModel)]="unidadeFilter"
             
              [disabled]="unidadeDisabled"
              (change)="onFilterChange()">
              <option value="">Todas</option>
              <option *ngFor="let unidade of unidades" [value]="unidade">
                {{ unidade }}
              </option>
            </select>
          </div>

          <div class="filter-group">
            <label for="origem">Comprado em</label>
            <select
              id="origem"
              class="form-control"
              [(ngModel)]="origemFilter"
              (change)="onFilterChange()">
              <option value="">Todas</option>
              <option *ngFor="let origem of origens" [value]="origem">
                {{ getOrigemLabel(origem) }}
              </option>
            </select>
          </div>

          <div class="filter-group value-range-group">
            <label>Valor da baixa</label>
            <div class="range-fields">
              <input
                id="valorMin"
                type="text"
                class="form-control small-field"
                [(ngModel)]="valorMinFilter"
                (blur)="onValorBlur('min')"
                placeholder="Mínimo"
                (keyup.enter)="onFilterChange()">
              <span class="range-separator">até</span>
              <input
                id="valorMax"
                type="text"
                class="form-control small-field"
                [(ngModel)]="valorMaxFilter"
                (blur)="onValorBlur('max')"
                placeholder="Máximo"
                (keyup.enter)="onFilterChange()">
            </div>
          </div>

          <div class="filter-group filter-actions">
            <label>&nbsp;</label>
            <div class="filter-action-buttons">
              <button class="btn btn-limpar" type="button" (click)="clearFilters()">
                <i class="fas fa-eraser"></i>
                Limpar Filtro
              </button>
              <button class="btn btn-aplicar" type="button" (click)="applyFilters()">
                <i class="fas fa-filter"></i>
                Aplicar Filtros
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="inline-loading" *ngIf="loading">
        <div class="spinner"></div>
        <span>Atualizando lista de baixas...</span>
      </div>

      <ng-container *ngIf="!loading">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Data baixa</th>
                <th>Protocolo</th>
                <th>Cliente</th>
                <th>Unidade</th>
                <th>Comprado em</th>
                <th>Tipo</th>
                <th>Valor</th>
                <th>Observação</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="items.length === 0">
                <td colspan="8" class="empty-state">
                  Nenhuma baixa encontrada para os filtros selecionados.
                </td>
              </tr>
              <tr
                *ngFor="let baixa of items"
                (click)="toggleSelectBaixa(baixa)"
                [class.row-selected]="isBaixaSelected(baixa)">
                <td>{{ baixa.dataBaixa | date: 'dd/MM/yyyy' }}</td>
                <td>{{ baixa.venda?.protocolo || '-' }}</td>
                <td>{{ getClienteNome(baixa.venda) }}</td>
                <td>{{ baixa.venda?.unidade || '-' }}</td>
                <td>{{ getOrigemLabel(baixa.venda?.origem) }}</td>
                <td>{{ baixa.tipoDaBaixa }}</td>
                <td>{{ formatCurrency(baixa.valorBaixa) }}</td>
                <td>{{ baixa.observacao || '-' }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="pagination" *ngIf="totalPages > 1">
          <button class="btn btn-sm btn-cancelar" (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1 || loading">
            <i class="fas fa-chevron-left"></i>
            Anterior
          </button>

          <span class="page-info">
            Página {{ currentPage }} de {{ totalPages }}
          </span>

          <button class="btn btn-sm btn-cancelar" (click)="onPageChange(currentPage + 1)" [disabled]="currentPage === totalPages || loading">
            Próxima
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </ng-container>
    </section>
    <app-lancar-baixa-modal
      [showModal]="showBaixaModal"
      [venda]="selectedVendaForBaixa"
      (close)="closeBaixaModal()"
      (modalClosed)="onBaixaModalClosed()">
    </app-lancar-baixa-modal>
  </div>
</ng-container>

<ng-template #noPermission>
  <div class="state-card error">
    <p>Você não possui permissão para visualizar esta página.</p>
  </div>
</ng-template>
