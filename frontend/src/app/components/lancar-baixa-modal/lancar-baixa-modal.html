<!-- Modal de Lançar Baixa - Design System -->
<div class="modal-overlay" *ngIf="showModal" (click)="!loading && onClose()">
  <div class="modal-conteudo modal-grande" (click)="$event.stopPropagation()">
    <div class="modal-cabecalho">
      <h3 class="modal-titulo">
        Baixar Protocolo: {{ venda?.protocolo }} ({{ getClienteNome(venda) }})
        <span class="valor-destaque">{{ formatCurrency(venda?.valorCliente || 0) }}</span>
      </h3>
      <button type="button" class="modal-fechar" (click)="onClose()" [attr.disabled]="loading ? 'disabled' : null">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-corpo" *ngIf="venda">
      <!-- Loading Baixas -->
      <div class="cartao" style="margin-bottom: var(--espacamento-lg);" *ngIf="loadingBaixas">
        <div class="cartao-corpo">
          <div class="loading-container">
            <div class="spinner"></div>
            <span>Carregando baixas...</span>
          </div>
        </div>
      </div>

      <!-- Formulário de Baixa -->
      <form (ngSubmit)="onSubmit()">
        <div class="grid-formulario-baixa">
          <div class="grupo-campo campo-reduzido">
            <label for="tipoDaBaixa" class="label-campo obrigatorio">Tipo da Baixa</label>
            <select
              id="tipoDaBaixa"
              [(ngModel)]="baixaData.tipoDaBaixa"
              name="tipoDaBaixa"
              class="campo"
              required>
              <option value="" disabled>Selecione o tipo</option>
              <option *ngFor="let tipo of tiposBaixa" [value]="tipo">
                {{ getTipoBaixaLabel(tipo) }}
              </option>
            </select>
          </div>

          <div class="grupo-campo campo-reduzido">
            <label for="valorBaixa" class="label-campo obrigatorio">Valor da Baixa</label>
            <input
              id="valorBaixa"
              type="text"
              [(ngModel)]="valorDisplay"
              name="valorDisplay"
              class="campo"
              placeholder="0,00"
              (input)="formatCurrencyInput($event)"
              (blur)="formatCurrencyOnBlur()"
              (focus)="onValorFocus()"
              required>
          </div>

          <div class="grupo-campo campo-reduzido">
            <label for="dataBaixa" class="label-campo obrigatorio">Data da Baixa</label>
            <input
              id="dataBaixa"
              type="date"
              [(ngModel)]="baixaData.dataBaixa"
              name="dataBaixa"
              class="campo"
              required>
          </div>

          <div class="grupo-campo campo-observacao">
            <label for="observacao" class="label-campo">Observação</label>
            <input
              id="observacao"
              type="text"
              [(ngModel)]="baixaData.observacao"
              name="observacao"
              class="campo"
              placeholder="Observações sobre a baixa..."
              maxlength="500">
          </div>

          <div class="grupo-campo campo-botao">
            <label class="label-campo" style="visibility: hidden;">Ação</label>
            <button
              type="submit"
              class="botao botao-primario botao-lancar-baixa"
              [attr.disabled]="loading ? 'disabled' : null"
              [ngClass]="{'botao-carregando': loading}">
              {{ loading ? (modoEdicao ? 'Atualizando...' : 'Lançando...') : (modoEdicao ? 'Atualizar Baixa' : 'Lançar Baixa') }}
            </button>
          </div>
        </div>
      </form>

      <!-- Baixas Existentes -->
      <div class="baixas-container" *ngIf="baixasExistentes.length > 0" style="margin-top: var(--espacamento-lg);">
        <h6 class="titulo-baixas">Baixas realizadas</h6>
        <div class="tabela-responsive">
          <table class="tabela">
            <thead>
              <tr>
                <th>Data Baixa</th>
                <th>Tipo Baixa</th>
                <th>Valor</th>
                <th>Obs</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let baixa of baixasExistentes" [class.editing-row]="baixaEmEdicao?.id === baixa.id">
                <td>{{ baixa.dataBaixa | date:'dd/MM/yyyy' }}</td>
                <td>{{ getTipoBaixaLabel(baixa.tipoDaBaixa) }}</td>
                <td>{{ formatCurrency(baixa.valorBaixa) }}</td>
                <td>{{ baixa.observacao || '-' }}</td>
                <td>
                  <button
                    *ngIf="hasPermission(Permission.VENDA_UPDATE)"
                    type="button"
                    [class]="baixaEmEdicao?.id === baixa.id ? 'btn btn-sm btn-cancelar' : 'btn btn-sm btn-editar'"
                    (click)="baixaEmEdicao?.id === baixa.id ? cancelarEdicao() : onEditarBaixa(baixa)"
                    [attr.disabled]="venda.dataFechamento ? 'disabled' : null"
                    [title]="baixaEmEdicao?.id === baixa.id ? 'Cancelar edição' : (venda.dataFechamento ? 'Venda fechada - edição não permitida' : 'Editar baixa')"
                    [ngClass]="{'opacity-50': venda.dataFechamento}">
                    {{ baixaEmEdicao?.id === baixa.id ? 'Cancelar Edição' : 'Editar' }}
                  </button>
                  <button
                    *ngIf="hasPermission(Permission.VENDA_REMOVE_BAIXA)"
                    type="button"
                    class="btn btn-sm btn-excluir"
                    (click)="onRemoverBaixa(baixa)"
                    [attr.disabled]="(deletingBaixaId === baixa.id || venda.dataFechamento) ? 'disabled' : null"
                    [title]="venda.dataFechamento ? 'Venda fechada - exclusão não permitida' : 'Remover baixa'"
                    [ngClass]="{'opacity-50': venda.dataFechamento}">
                    Excluir
                  </button>
                  <button
                    type="button"
                    class="btn btn-sm btn-recibo"
                    (click)="onImprimirRecibo(baixa)"
                    title="Gerar recibo de pagamento">
                    Recibo
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="resumo-baixas">
          <span class="resumo-item">
            <strong>Total Baixado:</strong>{{ formatCurrency(getTotalBaixas()) }}
          </span>
          <span class="resumo-item">
            <strong>Valor Cliente:</strong>{{ formatCurrency(venda.valorCliente) }}
          </span>
          <span class="resumo-item">
            <strong>Valor Restante:</strong>
            <span [class]="getValorRestante() > 0 ? 'text-warning' : 'text-success'">
              {{ formatCurrency(getValorRestante()) }}
            </span>
          </span>
        </div>
      </div>
    </div>

    <div class="modal-rodape">
      <button
        type="button"
        class="botao botao-fantasma"
        (click)="modoEdicao ? cancelarEdicao() : onClose()"
        [attr.disabled]="loading ? 'disabled' : null">
        {{ modoEdicao ? 'Cancelar Edição' : 'Cancelar' }}
      </button>
    </div>
  </div>
</div>

<!-- Modal de confirmação de exclusão de baixa -->
<app-confirmation-modal
  [isVisible]="showDeleteBaixaModal"
  title="Confirmar Exclusão"
  [message]="deleteModalMessage"
  confirmText="Excluir"
  cancelText="Cancelar"
  (confirmed)="onDeleteBaixaConfirmed()"
  (cancelled)="onDeleteBaixaCancelled()"
></app-confirmation-modal>

<!-- Modal de confirmação de fechamento -->
<app-confirmation-modal
  [isVisible]="showCloseConfirmationModal"
  title="Confirmar Fechamento"
  message="Você tem alterações não salvas. Deseja realmente fechar e perder as alterações?"
  confirmText="Fechar"
  cancelText="Cancelar"
  (confirmed)="onCloseConfirmed()"
  (cancelled)="onCloseCancelled()"
></app-confirmation-modal>

<!-- Modal de confirmação de data futura -->
<app-confirmation-modal
  [isVisible]="showDataFuturaModal"
  title="Confirmar Data Futura"
  [message]="'A data informada (' + formatDateDisplay(baixaData.dataBaixa) + ') é maior que a data atual. Deseja realmente realizar esta baixa com data futura?'"
  confirmText="Sim, Confirmar"
  cancelText="Cancelar"
  (confirmed)="onDataFuturaConfirmed()"
  (cancelled)="onDataFuturaCancelled()"
></app-confirmation-modal>
