<!-- Modal de Venda - Design System -->
<div class="modal-overlay" *ngIf="showModal" (click)="!isLoading && closeModal()">
  <div class="modal-conteudo modal-grande modal-venda" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="modal-cabecalho">
      <h3 class="modal-titulo">{{ isEditing ? 'Editar Venda' : 'Nova Venda' }}</h3>
      <button type="button" class="modal-fechar" (click)="closeModal()" [attr.disabled]="isLoading ? 'disabled' : null">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Form -->
    <form [formGroup]="vendaForm" (ngSubmit)="onSubmit()" class="modal-corpo">
      <!-- Primeira linha: Protocolo, Data Venda, Origem, Status, Unidade -->
      <div class="grid-formulario" style="grid-template-columns: repeat(5, 1fr); margin-bottom: var(--espacamento-md);">
        <div class="grupo-campo">
          <label for="protocolo" class="label-campo obrigatorio">Protocolo</label>
          <input
            #protocoloInput
            id="protocolo"
            type="text"
            formControlName="protocolo"
            class="campo"
            autocomplete="off"
            [ngClass]="{'invalido': hasFieldError('protocolo')}"
            placeholder="Digite o protocolo">
          <div class="mensagem-invalida" *ngIf="hasFieldError('protocolo')">
            {{ getFieldError('protocolo') }}
          </div>
        </div>

        <div class="grupo-campo">
          <label for="dataVenda" class="label-campo obrigatorio">Data</label>
          <input
            id="dataVenda"
            type="date"
            formControlName="dataVenda"
            class="campo"
            autocomplete="off"
            [ngClass]="{'invalido': hasFieldError('dataVenda')}">
          <div class="mensagem-invalida" *ngIf="hasFieldError('dataVenda')">
            {{ getFieldError('dataVenda') }}
          </div>
        </div>

        <div class="grupo-campo">
          <label for="origem" class="label-campo obrigatorio">Comprado em</label>
          <select
            id="origem"
            formControlName="origem"
            class="campo"
            [ngClass]="{'invalido': hasFieldError('origem')}">
            <option *ngFor="let origem of origens" [value]="origem">
              {{ getOrigemLabel(origem) }}
            </option>
          </select>
          <div class="mensagem-invalida" *ngIf="hasFieldError('origem')">
            {{ getFieldError('origem') }}
          </div>
        </div>

        <div class="grupo-campo">
          <label for="status" class="label-campo obrigatorio">Status</label>
          <select
            id="status"
            formControlName="status"
            class="campo"
            [ngClass]="{'invalido': hasFieldError('status')}">
            <option *ngFor="let status of [VendaStatus.REGISTRADO, VendaStatus.CANCELADO, VendaStatus.PAGO, VendaStatus.PAGO_PARCIAL]"
                    [value]="status">
              {{ getStatusLabel(status) }}
            </option>
          </select>
          <div class="mensagem-invalida" *ngIf="hasFieldError('status')">
            {{ getFieldError('status') }}
          </div>
        </div>

        <div class="grupo-campo">
          <label for="unidade" class="label-campo">Unidade</label>
          <select
            id="unidade"
            formControlName="unidade"
            class="campo"
            [attr.disabled]="unidadeDisabled ? 'disabled' : null">
            <option value="">Nenhuma</option>
            <option *ngFor="let unit of unidades" [value]="unit">
              {{ unit }}
            </option>
          </select>
          <div class="mensagem-invalida" *ngIf="hasFieldError('unidade')">
            {{ getFieldError('unidade') }}
          </div>
        </div>
      </div>

      <!-- Segunda linha: Cliente, Vendedor, Prescritor, Ativo -->
      <div class="grid-formulario grid-formulario-4-colunas" style="margin-bottom: var(--espacamento-md);">
        <div class="grupo-campo">
          <label for="clienteId" class="label-campo obrigatorio">Cliente</label>
          <app-autocomplete
            #clienteAutocomplete
            id="clienteId"
            type="cliente"
            formControlName="clienteId"
            placeholder="Digite o nome do cliente..."
            [required]="true"
            (createNew)="onCreateCliente($event)">
          </app-autocomplete>
          <div class="mensagem-invalida" *ngIf="hasFieldError('clienteId')">
            {{ getFieldError('clienteId') }}
          </div>
        </div>

        <div class="grupo-campo">
          <label for="vendedorId" class="label-campo obrigatorio">Vendedor</label>
          <app-autocomplete
            #vendedorAutocomplete
            id="vendedorId"
            type="vendedor"
            formControlName="vendedorId"
            placeholder="Digite o nome do vendedor..."
            [required]="true">
          </app-autocomplete>
          <div class="mensagem-invalida" *ngIf="hasFieldError('vendedorId')">
            {{ getFieldError('vendedorId') }}
          </div>
        </div>

        <div class="grupo-campo">
          <label for="prescritorId" class="label-campo">Prescritor</label>
          <app-autocomplete
            #prescritorAutocomplete
            id="prescritorId"
            type="prescritor"
            formControlName="prescritorId"
            placeholder="Digite o nome do prescritor..."
            [required]="false"
            (createNew)="onCreatePrescritor($event)">
          </app-autocomplete>
          <div class="mensagem-invalida" *ngIf="hasFieldError('prescritorId')">
            {{ getFieldError('prescritorId') }}
          </div>
        </div>

        <div class="grupo-campo">
          <label for="ativo" class="label-campo">Ativo</label>
          <input
            id="ativo"
            type="text"
            formControlName="ativo"
            class="campo"
            autocomplete="on"
            placeholder="Ex: Ativa, Pendente, etc"
            maxlength="300">
        </div>
      </div>

      <!-- Terceira linha: Valor Cliente, Valor Compra, Valor Pago -->
      <div class="grid-formulario grid-formulario-3-colunas" style="grid-template-columns: 1fr 0.8fr 0.2fr 0.8fr;">
        <div class="grupo-campo">
          <label for="valorCliente" class="label-campo obrigatorio">Valor Cliente</label>
          <div class="grupo-input">
            <span class="prefixo-input">R$</span>
            <input
              id="valorCliente"
              type="text"
              formControlName="valorCliente"
              class="campo"
              autocomplete="off"
              [ngClass]="{'invalido': hasFieldError('valorCliente')}"
              placeholder="0,00"
              (input)="formatCurrency($event, 'valorCliente')"
              (blur)="formatCurrencyOnBlur('valorCliente')">
          </div>
          <div class="mensagem-invalida" *ngIf="hasFieldError('valorCliente')">
            {{ getFieldError('valorCliente') }}
          </div>
        </div>

        <ng-container *ngIf="podeVisualizarValorCompra; else valorCompraPlaceholder">
          <div class="grupo-campo">
            <label for="valorCompra" class="label-campo">Valor Compra</label>
            <div class="grupo-input">
              <span class="prefixo-input">R$</span>
              <input
                id="valorCompra"
                type="text"
                formControlName="valorCompra"
                class="campo"
                autocomplete="off"
                [ngClass]="{'invalido': hasFieldError('valorCompra')}"
                placeholder="0,00"
                (input)="formatCurrency($event, 'valorCompra')"
                (blur)="formatCurrencyOnBlur('valorCompra')">
            </div>
            <div class="mensagem-invalida" *ngIf="hasFieldError('valorCompra')">
              {{ getFieldError('valorCompra') }}
            </div>
          </div>
        </ng-container>

        <div class="grupo-campo" *ngIf="podeVisualizarValorCompra">
          <label class="label-campo">&nbsp;</label>
          <button
            type="button"
            class="botao botao-icone botao-primario"
            style="height: 38px; width: 100%; border-radius: 6px;"
            title="Aplicar 35% de desconto do valor da compra no valor pago"
            (click)="aplicarDescontoValorPago()">
            %
          </button>
        </div>

        <ng-container *ngIf="podeVisualizarValorCompra; else valorPagoPlaceholder">
          <div class="grupo-campo">
            <label for="valorPago" class="label-campo">Valor Pago (Compra)</label>
            <div class="grupo-input">
              <span class="prefixo-input">R$</span>
              <input
                id="valorPago"
                type="text"
                formControlName="valorPago"
                class="campo"
                autocomplete="off"
                [ngClass]="{'invalido': hasFieldError('valorPago')}"
                placeholder="0,00"
                (input)="formatCurrency($event, 'valorPago')"
                (blur)="formatCurrencyOnBlur('valorPago')">
            </div>
            <div class="mensagem-invalida" *ngIf="hasFieldError('valorPago')">
              {{ getFieldError('valorPago') }}
            </div>
          </div>
        </ng-container>
      </div>

      <ng-template #valorCompraPlaceholder>
        <input type="hidden" formControlName="valorCompra">
      </ng-template>
      <ng-template #valorPagoPlaceholder>
        <input type="hidden" formControlName="valorPago">
      </ng-template>

      <!-- Observação -->
      <div class="grid-formulario">
        <div class="grupo-campo">
          <label for="observacao" class="label-campo">Observação</label>
          <textarea
            id="observacao"
            formControlName="observacao"
            class="campo"
            autocomplete="off"
            maxlength="500"
            rows="3"
            placeholder="Observações adicionais (opcional)">
          </textarea>
        </div>
      </div>
    </form>

    <!-- Actions -->
    <div class="modal-rodape">
      <button
        type="button"
        class="botao botao-fantasma"
        (click)="closeModal()"
        [attr.disabled]="isLoading ? 'disabled' : null"
        title="Cancelar">
        Cancelar
      </button>
      <button
        type="submit"
        class="botao botao-primario"
        (click)="onSubmit()"
        [attr.disabled]="(isLoading || vendaForm.invalid) ? 'disabled' : null"
        [ngClass]="{'botao-carregando': isLoading}">
        {{ isLoading ? 'Salvando...' : (isEditing ? 'Atualizar' : 'Criar Venda') }}
      </button>
    </div>
  </div>
</div>

<!-- Modal de Criação Rápida de Cliente -->
<app-cliente-quick-create-modal
  *ngIf="showClienteQuickCreateModal"
  [initialNome]="quickCreateClienteNome"
  [showModal]="showClienteQuickCreateModal"
  (created)="onClienteCreated($event)"
  (cancelled)="onClienteCreateCancelled()">
</app-cliente-quick-create-modal>

<!-- Modal de Criação Rápida de Prescritor -->
<app-prescritor-quick-create-modal
  *ngIf="showPrescritorQuickCreateModal"
  [initialNome]="quickCreatePrescritorNome"
  [showModal]="showPrescritorQuickCreateModal"
  (created)="onPrescritorCreated($event)"
  (cancelled)="onPrescritorCreateCancelled()">
</app-prescritor-quick-create-modal>

<!-- Modal de Confirmação de Fechamento -->
<app-confirmation-modal
  [isVisible]="showConfirmCloseModal"
  title="Confirmar Fechamento"
  message="Existem alterações não salvas. Tem certeza que deseja fechar o modal? Todas as alterações serão perdidas."
  confirmText="Fechar"
  cancelText="Continuar Editando"
  (confirmed)="confirmClose()"
  (cancelled)="cancelClose()">
</app-confirmation-modal>
